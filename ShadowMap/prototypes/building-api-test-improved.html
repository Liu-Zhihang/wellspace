<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建筑物API测试 - 改进版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .panel-content {
            padding: 20px;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .test-result {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            background: #ecf0f1;
        }

        .test-result.success {
            border-left-color: #27ae60;
            background: #d5edda;
        }

        .test-result.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }

        .test-result h4 {
            margin: 0 0 10px 0;
        }

        .test-result pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .legend {
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>🏢 建筑物API测试 - 改进版</h1>
    
    <div class="container">
        <!-- 地图面板 -->
        <div class="panel">
            <div class="panel-header">📍 交互式地图</div>
            <div class="panel-content">
                <div class="button-group">
                    <button onclick="loadBuildingsAtCurrentView()">加载当前视图建筑物</button>
                    <button onclick="clearAllLayers()">清除所有图层</button>
                    <button onclick="goToBeijing()">跳转到北京</button>
                    <button onclick="goToShanghai()">跳转到上海</button>
                </div>
                
                <div id="map"></div>
                
                <div class="legend">
                    <h4>图例</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(255,0,0,0.3); border-color: #ff0000;"></div>
                        <span>建筑物多边形</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(0,100,255,0.3); border-color: #0064ff;"></div>
                        <span>高层建筑 (>20m)</span>
                    </div>
                </div>

                <div class="stats" id="mapStats">
                    <div class="stat-item">
                        <div class="stat-value" id="buildingCount">0</div>
                        <div class="stat-label">建筑物数量</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tileCount">0</div>
                        <div class="stat-label">加载瓦片</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgHeight">0</div>
                        <div class="stat-label">平均高度(m)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 测试面板 -->
        <div class="panel">
            <div class="panel-header">🧪 API测试</div>
            <div class="panel-content">
                <div class="button-group">
                    <button onclick="testBuildingInfo()">测试服务信息</button>
                    <button onclick="testBuildingTile()">测试瓦片API</button>
                    <button onclick="testBuildingPreload()">测试预加载</button>
                    <button onclick="clearResults()">清除结果</button>
                </div>
                
                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 初始化地图
        const map = L.map('map').setView([39.9042, 116.4074], 15);
        
        // 添加底图
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 图层管理
        let buildingLayers = L.layerGroup().addTo(map);
        let totalBuildings = 0;
        let totalTiles = 0;
        let totalHeight = 0;

        // 显示测试结果
        function showResult(title, data, isError = false) {
            const output = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isError ? 'error' : 'success'}`;
            
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <pre>${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
                <small>测试时间: ${new Date().toLocaleString()}</small>
            `;
            
            output.insertBefore(resultDiv, output.firstChild);
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('buildingCount').textContent = totalBuildings;
            document.getElementById('tileCount').textContent = totalTiles;
            document.getElementById('avgHeight').textContent = totalBuildings > 0 ? Math.round(totalHeight / totalBuildings) : 0;
        }

        // 测试建筑物信息API
        async function testBuildingInfo() {
            try {
                showResult('🔄 正在测试建筑物信息API...', '请求中...');
                
                const response = await fetch('http://localhost:3001/api/buildings/info');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult('✅ 建筑物信息API测试成功', data);
            } catch (error) {
                showResult('❌ 建筑物信息API测试失败', error.message, true);
            }
        }

        // 测试建筑物瓦片API
        async function testBuildingTile() {
            try {
                showResult('🔄 正在测试建筑物瓦片API...', '请求中...');
                
                // 使用北京市中心的瓦片坐标
                const z = 16;
                const x = 53957;
                const y = 24832;
                
                const response = await fetch(`http://localhost:3001/api/buildings/${z}/${x}/${y}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult(`✅ 建筑物瓦片API测试成功 (${z}/${x}/${y})`, {
                    tileInfo: data.tileInfo,
                    buildingCount: data.features.length,
                    bbox: data.bbox,
                    sampleBuilding: data.features[0] || '无建筑物数据'
                });
                
                // 在地图上显示建筑物
                loadBuildingData(data);
                
            } catch (error) {
                showResult('❌ 建筑物瓦片API测试失败', error.message, true);
            }
        }

        // 测试建筑物预加载API
        async function testBuildingPreload() {
            try {
                showResult('🔄 正在测试建筑物预加载API...', '请求中...');
                
                const lng = 116.4074;
                const lat = 39.9042;
                const radius = 1; // 1公里
                const zoom = 16;
                
                const response = await fetch('http://localhost:3001/api/buildings/preload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lng: lng,
                        lat: lat,
                        radius: radius,
                        zoomLevel: zoom
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult('✅ 建筑物预加载API测试成功', data);
            } catch (error) {
                showResult('❌ 建筑物预加载API测试失败', error.message, true);
            }
        }

        // 加载建筑物数据到地图
        function loadBuildingData(geoJsonData) {
            const geoJsonLayer = L.geoJSON(geoJsonData, {
                style: function(feature) {
                    const height = feature.properties.height || 10;
                    const isHighRise = height > 20;
                    
                    return {
                        color: isHighRise ? '#0064ff' : '#ff0000',
                        weight: 2,
                        fillOpacity: 0.4,
                        fillColor: isHighRise ? '#0064ff' : '#ff0000'
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        const props = feature.properties;
                        layer.bindPopup(`
                            <div style="min-width: 200px;">
                                <h4>🏢 建筑物详情</h4>
                                <p><strong>ID:</strong> ${props.id || '未知'}</p>
                                <p><strong>类型:</strong> ${props.buildingType || '未知'}</p>
                                <p><strong>高度:</strong> ${props.height || '未知'}m</p>
                                <p><strong>楼层:</strong> ${props.levels || '未知'}</p>
                            </div>
                        `);
                        
                        // 更新统计
                        totalBuildings++;
                        totalHeight += (props.height || 10);
                    }
                }
            });
            
            buildingLayers.addLayer(geoJsonLayer);
            totalTiles++;
            updateStats();
            
            // 调整地图视图到建筑物范围
            if (geoJsonData.features && geoJsonData.features.length > 0) {
                map.fitBounds(geoJsonLayer.getBounds(), { padding: [20, 20] });
            }
        }

        // 加载当前视图的建筑物
        async function loadBuildingsAtCurrentView() {
            const bounds = map.getBounds();
            const zoom = Math.min(Math.max(map.getZoom(), 14), 17);
            
            try {
                showResult('🔄 正在加载当前视图的建筑物...', `缩放级别: ${zoom}`);
                
                // 计算当前视图需要的瓦片
                const tiles = getTilesInBounds(bounds, zoom);
                
                for (const tile of tiles) {
                    const response = await fetch(`http://localhost:3001/api/buildings/${tile.z}/${tile.x}/${tile.y}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        loadBuildingData(data);
                    }
                }
                
                showResult('✅ 建筑物加载完成', `加载了 ${tiles.length} 个瓦片`);
                
            } catch (error) {
                showResult('❌ 建筑物加载失败', error.message, true);
            }
        }

        // 计算边界框内的瓦片
        function getTilesInBounds(bounds, zoom) {
            const tiles = [];
            const nw = bounds.getNorthWest();
            const se = bounds.getSouthEast();
            
            const minTile = latLngToTile(nw.lat, nw.lng, zoom);
            const maxTile = latLngToTile(se.lat, se.lng, zoom);
            
            for (let x = minTile.x; x <= maxTile.x; x++) {
                for (let y = minTile.y; y <= maxTile.y; y++) {
                    tiles.push({ z: zoom, x: x, y: y });
                }
            }
            
            return tiles;
        }

        // 经纬度转瓦片坐标
        function latLngToTile(lat, lng, zoom) {
            const n = Math.pow(2, zoom);
            const x = Math.floor((lng + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(lat * Math.PI / 180)) / Math.PI) / 2 * n);
            return { x, y };
        }

        // 清除所有图层
        function clearAllLayers() {
            buildingLayers.clearLayers();
            totalBuildings = 0;
            totalTiles = 0;
            totalHeight = 0;
            updateStats();
            showResult('🧹 图层已清除', '所有建筑物图层已移除');
        }

        // 清除测试结果
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // 跳转到指定城市
        function goToBeijing() {
            map.setView([39.9042, 116.4074], 15);
        }

        function goToShanghai() {
            map.setView([31.2304, 121.4737], 15);
        }

        // 页面加载时自动测试
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                showResult('🏥 后端健康检查', data);
            } catch (error) {
                showResult('❌ 后端连接失败', '请确保后端服务器在运行 (http://localhost:3001)', true);
            }
        });
    </script>
</body>
</html>
