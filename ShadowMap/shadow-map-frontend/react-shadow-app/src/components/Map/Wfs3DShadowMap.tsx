import React, { useEffect, useRef, useState, useCallback } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';
import { useShadowMapStore } from '../../store/shadowMapStore';
import { shadowAnalysisService, ShadowCalculationResult } from '../../services/shadowAnalysisService';
import { getWfsBuildings } from '../../services/wfsBuildingService';
import { debugHelper } from '../../utils/debugHelper';
import { LayerDiagnostics } from '../../utils/layerDiagnostics';
import * as SunCalc from 'suncalc';

interface Wfs3DShadowMapProps {
  className?: string;
}

export const Wfs3DShadowMap: React.FC<Wfs3DShadowMapProps> = ({ className = '' }) => {
  const mapContainerRef = useRef<HTMLDivElement>(null);
  const mapRef = useRef<mapboxgl.Map | null>(null);
  const [is3D, setIs3D] = useState(true); // ÈªòËÆ§3DÊ®°Âºè
  const [isLoading, setIsLoading] = useState(false);
  const [isCalculatingShadows, setIsCalculatingShadows] = useState(false);
  const [shadowData, setShadowData] = useState<ShadowCalculationResult | null>(null);
  
  const {
    mapSettings,
    currentDate,
    addStatusMessage,
    setMapView,
  } = useShadowMapStore();

  // ÂàùÂßãÂåñÂú∞Âõæ
  useEffect(() => {
    if (!mapContainerRef.current || mapRef.current) return;

    console.log('üó∫Ô∏è Initialising WFS 3D shadow map...');

    mapboxgl.accessToken = 'pk.eyJ1Ijoid3VqbGluIiwiYSI6ImNtM2lpemVjZzAxYnIyaW9pMGs1aDB0cnkifQ.sxVHnoUGRV51ayrECnENoQ';

    const map = new mapboxgl.Map({
      container: mapContainerRef.current,
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [116.4074, 39.9042],
      zoom: 15,
      pitch: 60, // ÈªòËÆ§3D‰øØ‰ª∞Ëßí
      bearing: -17.6, // ÈªòËÆ§3DÊñπ‰ΩçËßí
      hash: true,
      antialias: true,
    });

    mapRef.current = map;

    map.on('load', () => {
      console.log('‚úÖ WFS 3D shadow map ready');
      loadWfsBuildings();
      
      // Á´ãÂç≥Ê∑ªÂä†ÊµãËØïÈò¥ÂΩ±
      setTimeout(() => {
        addRealBuildingShadows();
      }, 1000);
      
      map.on('click', handleMapClick);
      map.on('moveend', handleMapMove);
    });

    return () => {
      if (mapRef.current) {
        mapRef.current.remove();
        mapRef.current = null;
      }
    };
  }, []);

  // ÁõëÂê¨Êó∂Èó¥ÂèòÂåñÔºåÈáçÊñ∞ËÆ°ÁÆóÈò¥ÂΩ±
  useEffect(() => {
    if (mapRef.current && shadowData) {
      calculateShadows();
    }
  }, [currentDate]);

  // Âä†ËΩΩWFSÂª∫Á≠ëÁâ©Êï∞ÊçÆ
  const loadWfsBuildings = async () => {
    if (!mapRef.current) return;

    setIsLoading(true);
    try {
      const mapBounds = mapRef.current.getBounds();
      const buildingData = await getWfsBuildings({
        north: mapBounds.getNorth(),
        south: mapBounds.getSouth(),
        east: mapBounds.getEast(),
        west: mapBounds.getWest()
      });

      if (buildingData.success && buildingData.data.features.length > 0) {
        addBuildingsToMap(buildingData.data);
        addStatusMessage(`Loaded ${buildingData.data.features.length} buildings from WFS`, 'info');
        
        // Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ËÆ°ÁÆóÁúüÂÆûÈò¥ÂΩ±
        setTimeout(() => {
          addRealBuildingShadows();
        }, 500);
      } else {
        addStatusMessage('No building data returned from WFS', 'warning');
        // Âç≥‰ΩøÊ≤°ÊúâÂª∫Á≠ëÁâ©Êï∞ÊçÆÔºå‰πüÊ∑ªÂä†ÊµãËØïÈò¥ÂΩ±
        addRealBuildingShadows();
      }
    } catch (error) {
      console.error('[ShadowMap] Failed to load WFS buildings', error);
      addStatusMessage(`Failed to load WFS buildings: ${error}`, 'error');
    } finally {
      setIsLoading(false);
    }
  };

  // ËÆ°ÁÆóÂÆûÊó∂Èò¥ÂΩ±
  const calculateShadows = useCallback(async () => {
    if (!mapRef.current) return;

    setIsCalculatingShadows(true);
    try {
      const mapBounds = mapRef.current.getBounds();
      const zoom = mapRef.current.getZoom();
      
      // È™åËØÅMapbox boundsÂØπË±°
      if (!debugHelper.validateMapboxBounds(mapBounds)) {
        throw new Error('Invalid map bounds object');
      }
      
      // ËΩ¨Êç¢Mapbox bounds‰∏∫ShadowBoundsÊ†ºÂºè
      const bounds = {
        north: mapBounds.getNorth(),
        south: mapBounds.getSouth(),
        east: mapBounds.getEast(),
        west: mapBounds.getWest()
      };
      
      // È™åËØÅËΩ¨Êç¢ÂêéÁöÑËæπÁïåÂØπË±°
      if (!debugHelper.validateConvertedBounds(bounds)) {
        throw new Error('Invalid converted bounds object');
      }
      
      // ËÆ∞ÂΩïË∞ÉËØï‰ø°ÊÅØ
      debugHelper.logDebugInfo({
        mapBounds: {
          north: mapBounds.getNorth(),
          south: mapBounds.getSouth(),
          east: mapBounds.getEast(),
          west: mapBounds.getWest()
        },
        convertedBounds: bounds,
        currentDate,
        zoom,
        mapReady: true,
        timestamp: new Date().toISOString()
      });
      
      console.log('üåÖ ÂºÄÂßãËÆ°ÁÆóÈò¥ÂΩ±ÔºåËæπÁïå:', bounds);
      const result = await shadowAnalysisService.calculateRealTimeShadows(bounds, currentDate, zoom);
      
      setShadowData(result);
      addShadowsToMap(result);
      
      addStatusMessage(
        `Èò¥ÂΩ±ËÆ°ÁÆóÂÆåÊàê: ${result.shadows.length} ‰∏™Èò¥ÂΩ±, Áî®Êó∂ ${result.calculationTime.toFixed(0)}ms`,
        'info'
      );
    } catch (error) {
      console.error('‚ùå Èò¥ÂΩ±ËÆ°ÁÆóÂ§±Ë¥•:', error);
      addStatusMessage(`Èò¥ÂΩ±ËÆ°ÁÆóÂ§±Ë¥•: ${error}`, 'error');
    } finally {
      setIsCalculatingShadows(false);
    }
  }, [currentDate, addStatusMessage]);

  // Â∞ÜÂª∫Á≠ëÁâ©Ê∑ªÂä†Âà∞Âú∞Âõæ
  const addBuildingsToMap = (buildingData: any) => {
    if (!mapRef.current) return;

    const map = mapRef.current;
    const sourceId = 'wfs-buildings';
    const fillLayerId = 'wfs-buildings-fill';
    const outlineLayerId = 'wfs-buildings-outline';
    const extrusionLayerId = 'wfs-buildings-extrusion';

    // ÁßªÈô§Áé∞ÊúâÂõæÂ±Ç
    [fillLayerId, outlineLayerId, extrusionLayerId].forEach(layerId => {
      if (map.getLayer(layerId)) map.removeLayer(layerId);
    });
    if (map.getSource(sourceId)) map.removeSource(sourceId);

    // Â§ÑÁêÜÂª∫Á≠ëÁâ©Êï∞ÊçÆ
    const processedFeatures = buildingData.features.map((feature: any) => {
      if (!feature.properties) feature.properties = {};
      
      if (!feature.properties.height) {
        feature.properties.height = feature.properties.levels ? 
          feature.properties.levels * 3.5 : 
          estimateBuildingHeight(feature.properties.buildingType || 'building');
      }
      
      return feature;
    });

    // Ê∑ªÂä†Êï∞ÊçÆÊ∫ê
    map.addSource(sourceId, {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: processedFeatures
      }
    });

    // Ê∑ªÂä†2DÂ°´ÂÖÖÂõæÂ±Ç
    map.addLayer({
      id: fillLayerId,
      type: 'fill',
      source: sourceId,
      paint: {
        'fill-color': '#D3D3D3',
        'fill-opacity': 0.8
      }
    });
    
    console.log(`‚úÖ Âª∫Á≠ëÁâ©ÂõæÂ±ÇÊ∑ªÂä†ÊàêÂäü: ${processedFeatures.length} ‰∏™Âª∫Á≠ëÁâ©`);

    // Ê∑ªÂä†ËΩÆÂªìÂõæÂ±Ç
    map.addLayer({
      id: outlineLayerId,
      type: 'line',
      source: sourceId,
      paint: {
        'line-color': '#A0A0A0',
        'line-width': 1,
        'line-opacity': 0.9
      }
    });

    // Ê∑ªÂä†3DÊå§Âá∫ÂõæÂ±Ç
    map.addLayer({
      id: extrusionLayerId,
      type: 'fill-extrusion',
      source: sourceId,
      paint: {
        'fill-extrusion-color': '#D3D3D3',
        'fill-extrusion-height': [
          'interpolate',
          ['linear'],
          ['get', 'height'],
          0, 0,
          100, ['get', 'height']
        ],
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.8
      }
    });

    // ÂàùÂßãÊó∂ÊòæÁ§∫3DÂõæÂ±ÇÔºàÈªòËÆ§3DÊ®°ÂºèÔºâ
    map.setLayoutProperty(extrusionLayerId, 'visibility', 'visible');
    map.setLayoutProperty(fillLayerId, 'visibility', 'none');
    map.setLayoutProperty(outlineLayerId, 'visibility', 'none');
    
    console.log('üèóÔ∏è Âª∫Á≠ëÁâ©ÂõæÂ±ÇÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâçÊ®°Âºè: 3D');
  };

  // Â∞ÜÈò¥ÂΩ±Ê∑ªÂä†Âà∞Âú∞Âõæ
  const addShadowsToMap = (shadowResult: ShadowCalculationResult) => {
    if (!mapRef.current) return;

    const map = mapRef.current;
    const sourceId = 'wfs-shadows';
    const shadowLayerId = 'wfs-shadows-fill';

    console.log(`üåÖ ÂºÄÂßãÊ∑ªÂä†Èò¥ÂΩ±Âà∞Âú∞Âõæ: ${shadowResult.shadows.length} ‰∏™Èò¥ÂΩ±`);

    // ÁßªÈô§Áé∞ÊúâÈò¥ÂΩ±ÂõæÂ±Ç
    if (map.getLayer(shadowLayerId)) {
      map.removeLayer(shadowLayerId);
      console.log('üóëÔ∏è ÁßªÈô§Áé∞ÊúâÈò¥ÂΩ±ÂõæÂ±Ç');
    }
    if (map.getSource(sourceId)) {
      map.removeSource(sourceId);
      console.log('üóëÔ∏è ÁßªÈô§Áé∞ÊúâÈò¥ÂΩ±Êï∞ÊçÆÊ∫ê');
    }

    if (shadowResult.shadows.length === 0) {
      console.log('‚ö†Ô∏è Ê≤°ÊúâÈò¥ÂΩ±ÈúÄË¶ÅÊòæÁ§∫');
      return;
    }

    // Ê∑ªÂä†Èò¥ÂΩ±Êï∞ÊçÆÊ∫ê
    map.addSource(sourceId, {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: shadowResult.shadows
      }
    });
    console.log('‚úÖ Èò¥ÂΩ±Êï∞ÊçÆÊ∫êÊ∑ªÂä†ÊàêÂäü');

    // Ê∑ªÂä†Èò¥ÂΩ±Â°´ÂÖÖÂõæÂ±Ç - Ê∑°Á¥´Ëâ≤
    map.addLayer({
      id: shadowLayerId,
      type: 'fill',
      source: sourceId,
      paint: {
        'fill-color': '#DDA0DD', // Ê∑°Á¥´Ëâ≤
        'fill-opacity': 0.6
      }
    });
    console.log('‚úÖ Èò¥ÂΩ±Â°´ÂÖÖÂõæÂ±ÇÊ∑ªÂä†ÊàêÂäü');

    // Á°Æ‰øùÈò¥ÂΩ±ÂõæÂ±ÇÂú®ÊúÄ‰∏äÂ±Ç
    map.moveLayer(shadowLayerId);
    console.log('‚úÖ Èò¥ÂΩ±ÂõæÂ±ÇÂ∑≤ÁßªËá≥ÊúÄ‰∏äÂ±Ç');

    console.log(`‚úÖ ÊàêÂäüÊ∑ªÂä†‰∫Ü ${shadowResult.shadows.length} ‰∏™Èò¥ÂΩ±Âà∞Âú∞Âõæ`);
  };

  // Ê∑ªÂä†Âü∫‰∫éÂª∫Á≠ëÁâ©ÁöÑÁúüÂÆûÈò¥ÂΩ±
  const addRealBuildingShadows = () => {
    if (!mapRef.current) return;
    
    try {
      const map = mapRef.current;
      const shadowSource = 'real-building-shadows';
      const shadowLayer = 'real-building-shadows-fill';
      
      // ÁßªÈô§Áé∞ÊúâÈò¥ÂΩ±
      if (map.getLayer(shadowLayer)) map.removeLayer(shadowLayer);
      if (map.getSource(shadowSource)) map.removeSource(shadowSource);
      
      // Ëé∑ÂèñÂª∫Á≠ëÁâ©Êï∞ÊçÆ
      const buildingSource = map.getSource('wfs-buildings');
      if (!buildingSource || !buildingSource._data) {
        console.log('‚ö†Ô∏è Ê≤°ÊúâÂª∫Á≠ëÁâ©Êï∞ÊçÆÔºåÊó†Ê≥ïÁîüÊàêÈò¥ÂΩ±');
        return;
      }
      
      const buildings = buildingSource._data.features;
      if (!buildings || buildings.length === 0) {
        console.log('‚ö†Ô∏è Âª∫Á≠ëÁâ©Êï∞ÊçÆ‰∏∫Á©∫ÔºåÊó†Ê≥ïÁîüÊàêÈò¥ÂΩ±');
        return;
      }
      
      // ËÆ°ÁÆóÂ§™Èò≥‰ΩçÁΩÆ
      const bounds = map.getBounds();
      const lat = (bounds.getNorth() + bounds.getSouth()) / 2;
      const lng = (bounds.getEast() + bounds.getWest()) / 2;
      const sunPosition = calculateSunPosition(lat, lng, currentDate);
      
      console.log(`‚òÄÔ∏è Â§™Èò≥‰ΩçÁΩÆ: È´òÂ∫¶Ëßí ${sunPosition.altitude.toFixed(1)}¬∞, Êñπ‰ΩçËßí ${sunPosition.azimuth.toFixed(1)}¬∞`);
      
      // ‰∏∫ÊØè‰∏™Âª∫Á≠ëÁâ©ËÆ°ÁÆóÈò¥ÂΩ±
      const shadowFeatures = buildings.map((building: any) => {
        if (!building.geometry || !building.properties) return null;
        
        const height = building.properties.height || 20;
        const geometry = building.geometry;
        
        // Â§™Èò≥È´òÂ∫¶ËßíÂ§™‰ΩéÔºå‰∏ç‰∫ßÁîüÈò¥ÂΩ±
        if (sunPosition.altitude <= 0) return null;
        
        // ËÆ°ÁÆóÈò¥ÂΩ±ÈïøÂ∫¶
        const shadowLength = height / Math.tan((sunPosition.altitude * Math.PI) / 180);
        
        // ËÆ°ÁÆóÈò¥ÂΩ±ÊñπÂêëÔºàÊñπ‰ΩçËßíÔºâ
        const shadowDirection = (sunPosition.azimuth + 180) % 360;
        const shadowDirectionRad = (shadowDirection * Math.PI) / 180;
        
        // ËÆ°ÁÆóÈò¥ÂΩ±ÂÅèÁßª
        const offsetX = shadowLength * Math.sin(shadowDirectionRad);
        const offsetY = shadowLength * Math.cos(shadowDirectionRad);
        
        // Ê†πÊçÆÂá†‰ΩïÁ±ªÂûãÂ§ÑÁêÜÈò¥ÂΩ±
        let shadowGeometry;
        
        if (geometry.type === 'Polygon') {
          shadowGeometry = calculatePolygonShadow(geometry.coordinates[0], offsetX, offsetY);
        } else if (geometry.type === 'MultiPolygon') {
          const shadowCoordinates = geometry.coordinates.map((polygon: any) => 
            polygon.map((ring: any) => 
              calculatePolygonShadow(ring, offsetX, offsetY)
            )
          );
          shadowGeometry = {
            type: 'MultiPolygon',
            coordinates: shadowCoordinates
          };
        } else {
          return null;
        }
        
        return {
          type: 'Feature',
          geometry: shadowGeometry,
          properties: {
            buildingId: building.properties.id || `building_${Math.random()}`,
            buildingHeight: height,
            shadowLength: shadowLength
          }
        };
      }).filter(Boolean);
      
      if (shadowFeatures.length === 0) {
        console.log('‚ö†Ô∏è Ê≤°ÊúâÁîüÊàê‰ªª‰ΩïÈò¥ÂΩ±');
        return;
      }
      
      // Ê∑ªÂä†Èò¥ÂΩ±Êï∞ÊçÆÊ∫ê
      map.addSource(shadowSource, {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: shadowFeatures
        }
      });
      
      // Ê∑ªÂä†Èò¥ÂΩ±ÂõæÂ±Ç
      map.addLayer({
        id: shadowLayer,
        type: 'fill',
        source: shadowSource,
        paint: {
          'fill-color': '#DDA0DD',
          'fill-opacity': 0.6
        }
      });
      
      console.log(`‚úÖ Âü∫‰∫éÂª∫Á≠ëÁâ©ÁîüÊàê‰∫Ü ${shadowFeatures.length} ‰∏™ÁúüÂÆûÈò¥ÂΩ±`);
      addStatusMessage(`ÁîüÊàê‰∫Ü ${shadowFeatures.length} ‰∏™Âª∫Á≠ëÁâ©Èò¥ÂΩ±`, 'info');
    } catch (error) {
      console.error('‚ùå ÁîüÊàêÂª∫Á≠ëÁâ©Èò¥ÂΩ±Â§±Ë¥•:', error);
      addStatusMessage(`ÁîüÊàêÈò¥ÂΩ±Â§±Ë¥•: ${error}`, 'error');
    }
  };
  
  // ËÆ°ÁÆóÂ§™Èò≥‰ΩçÁΩÆ
  const calculateSunPosition = (lat: number, lng: number, date: Date) => {
    const sunPosition = SunCalc.getPosition(date, lat, lng);
    return {
      altitude: (sunPosition.altitude * 180) / Math.PI,
      azimuth: ((sunPosition.azimuth * 180) / Math.PI + 180) % 360
    };
  };
  
  // ËÆ°ÁÆóÂ§öËæπÂΩ¢Èò¥ÂΩ±
  const calculatePolygonShadow = (coordinates: number[][], offsetX: number, offsetY: number) => {
    return coordinates.map(coord => [
      coord[0] + offsetX,
      coord[1] + offsetY
    ]);
  };

  // ‰º∞ÁÆóÂª∫Á≠ëÁâ©È´òÂ∫¶
  const estimateBuildingHeight = (buildingType: string): number => {
    const heightMap: { [key: string]: number } = {
      'residential': 20,
      'commercial': 30,
      'office': 40,
      'industrial': 15,
      'school': 15,
      'hospital': 25,
      'hotel': 35,
      'retail': 12,
      'warehouse': 8,
      'building': 20
    };
    return heightMap[buildingType] || 20;
  };

  // ÂàáÊç¢2D/3DÊ®°Âºè
  const toggle2D3D = () => {
    if (!mapRef.current) return;

    const map = mapRef.current;
    const extrusionLayerId = 'wfs-buildings-extrusion';
    const fillLayerId = 'wfs-buildings-fill';
    const outlineLayerId = 'wfs-buildings-outline';

    console.log(`üîÑ ÂàáÊç¢Ê®°Âºè: ${is3D ? '3D' : '2D'} ‚Üí ${!is3D ? '3D' : '2D'}`);

    setIs3D(!is3D);

    if (!is3D) {
      // ÂàáÊç¢Âà∞3DÊ®°Âºè
      console.log('üèóÔ∏è ÂàáÊç¢Âà∞3DÊ®°Âºè...');
      
      // Á°Æ‰øùÂõæÂ±ÇÂ≠òÂú®
      if (map.getLayer(extrusionLayerId)) {
        map.setLayoutProperty(extrusionLayerId, 'visibility', 'visible');
        console.log('‚úÖ 3DÊå§Âá∫ÂõæÂ±ÇÂ∑≤ÊòæÁ§∫');
      } else {
        console.warn('‚ö†Ô∏è 3DÊå§Âá∫ÂõæÂ±Ç‰∏çÂ≠òÂú®');
      }
      
      if (map.getLayer(fillLayerId)) {
        map.setLayoutProperty(fillLayerId, 'visibility', 'none');
        console.log('‚úÖ 2DÂ°´ÂÖÖÂõæÂ±ÇÂ∑≤ÈöêËóè');
      }
      
      if (map.getLayer(outlineLayerId)) {
        map.setLayoutProperty(outlineLayerId, 'visibility', 'none');
        console.log('‚úÖ 2DËΩÆÂªìÂõæÂ±ÇÂ∑≤ÈöêËóè');
      }
      
      map.easeTo({
        pitch: 60,
        bearing: -17.6,
        duration: 1000
      });
      
      addStatusMessage('Â∑≤ÂàáÊç¢Âà∞3DÊ®°Âºè', 'info');
    } else {
      // ÂàáÊç¢Âà∞2DÊ®°Âºè
      console.log('üìê ÂàáÊç¢Âà∞2DÊ®°Âºè...');
      
      if (map.getLayer(extrusionLayerId)) {
        map.setLayoutProperty(extrusionLayerId, 'visibility', 'none');
        console.log('‚úÖ 3DÊå§Âá∫ÂõæÂ±ÇÂ∑≤ÈöêËóè');
      }
      
      if (map.getLayer(fillLayerId)) {
        map.setLayoutProperty(fillLayerId, 'visibility', 'visible');
        console.log('‚úÖ 2DÂ°´ÂÖÖÂõæÂ±ÇÂ∑≤ÊòæÁ§∫');
      }
      
      if (map.getLayer(outlineLayerId)) {
        map.setLayoutProperty(outlineLayerId, 'visibility', 'visible');
        console.log('‚úÖ 2DËΩÆÂªìÂõæÂ±ÇÂ∑≤ÊòæÁ§∫');
      }
      
      map.easeTo({
        pitch: 0,
        bearing: 0,
        duration: 1000
      });
      
      addStatusMessage('Â∑≤ÂàáÊç¢Âà∞2DÊ®°Âºè', 'info');
    }
  };

  // Èò≤ÊäñÂÆöÊó∂Âô®
  const moveTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Â§ÑÁêÜÂú∞ÂõæÁßªÂä®
  const handleMapMove = () => {
    if (!mapRef.current) return;
    
    const center = mapRef.current.getCenter();
    const zoom = mapRef.current.getZoom();
    setMapView([center.lat, center.lng], zoom);
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
    if (moveTimeoutRef.current) {
      clearTimeout(moveTimeoutRef.current);
    }
    
    // Âú∞ÂõæÁßªÂä®ÂêéÈáçÊñ∞Âä†ËΩΩÂª∫Á≠ëÁâ©Êï∞ÊçÆÂíåËÆ°ÁÆóÈò¥ÂΩ±ÔºàÈò≤ÊäñÔºâ
    if (zoom >= 14) {
      console.log('üîÑ Âú∞ÂõæÁßªÂä®ÔºåÂáÜÂ§áÈáçÊñ∞Âä†ËΩΩ...');
      moveTimeoutRef.current = setTimeout(async () => {
        try {
          await loadWfsBuildings();
          setTimeout(() => {
            addRealBuildingShadows();
          }, 500);
        } catch (error) {
          console.error('‚ùå Âú∞ÂõæÁßªÂä®ÂêéÈáçÊñ∞Âä†ËΩΩÂ§±Ë¥•:', error);
        }
      }, 2000); // 2ÁßíÈò≤Êäñ
    }
  };

  // Â§ÑÁêÜÂú∞ÂõæÁÇπÂáª
  const handleMapClick = (e: mapboxgl.MapMouseEvent) => {
    if (!mapRef.current) return;

    const features = mapRef.current.queryRenderedFeatures(e.point, {
      layers: ['wfs-buildings-fill', 'wfs-buildings-extrusion']
    });

    if (features.length > 0) {
      const feature = features[0];
      const props = feature.properties;
      
      new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`
          <div class="min-w-48">
            <h4 class="font-bold text-gray-800 mb-2">üè¢ Âª∫Á≠ëÁâ©‰ø°ÊÅØ</h4>
            <p><strong>Á±ªÂûã:</strong> ${props.buildingType || 'Êú™Áü•'}</p>
            <p><strong>È´òÂ∫¶:</strong> ${props.height || 'Êú™Áü•'}m</p>
            <p><strong>Ê•ºÂ±Ç:</strong> ${props.levels || 'Êú™Áü•'}</p>
            <p><strong>Êï∞ÊçÆÊ∫ê:</strong> WFS ÊúçÂä°</p>
            ${shadowData ? `
              <hr class="my-2">
              <h5 class="font-semibold text-gray-700 mb-1">‚òÄÔ∏è Â§™Èò≥‰ø°ÊÅØ</h5>
              <p><strong>È´òÂ∫¶Ëßí:</strong> ${shadowData.sunPosition.altitude.toFixed(1)}¬∞</p>
              <p><strong>Êñπ‰ΩçËßí:</strong> ${shadowData.sunPosition.azimuth.toFixed(1)}¬∞</p>
            ` : ''}
          </div>
        `)
        .addTo(mapRef.current);
    }
  };

  return (
    <div className={`relative w-full h-full ${className}`}>
      {/* Âú∞ÂõæÂÆπÂô® */}
      <div ref={mapContainerRef} className="w-full h-full" />
      
      {/* ÊéßÂà∂Èù¢Êùø - Á°Æ‰øùÂú®ÊúÄÈ°∂Â±Ç */}
      <div className="absolute top-4 right-4 z-[9999] space-y-2">
        {/* 2D/3DÂàáÊç¢ÊåâÈíÆ */}
        <button
          onClick={toggle2D3D}
          className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-lg"
          disabled={isLoading || isCalculatingShadows}
        >
          {isLoading ? (
            <>
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"></div>
              Âä†ËΩΩ‰∏≠...
            </>
          ) : isCalculatingShadows ? (
            <>
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
              ËÆ°ÁÆóÈò¥ÂΩ±...
            </>
          ) : is3D ? (
            <>
              <span>üìê</span>
              ÂàáÊç¢Âà∞2D
            </>
          ) : (
            <>
              <span>üèóÔ∏è</span>
              ÂàáÊç¢Âà∞3D
            </>
          )}
        </button>

        {/* Âà∑Êñ∞ÊåâÈíÆ */}
        <button
          onClick={async () => {
            console.log('üîÑ Âà∑Êñ∞ÊâÄÊúâÂõæÂ±Ç...');
            setIsLoading(true);
            try {
              await loadWfsBuildings();
              addStatusMessage('ÂõæÂ±ÇÂ∑≤Âà∑Êñ∞', 'info');
            } catch (error) {
              console.error('‚ùå Âà∑Êñ∞Â§±Ë¥•:', error);
              addStatusMessage(`Âà∑Êñ∞Â§±Ë¥•: ${error}`, 'error');
            } finally {
              setIsLoading(false);
            }
          }}
          className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-lg"
        >
          <span>üîÑ</span>
          Âà∑Êñ∞
        </button>
      </div>

      {/* Âä†ËΩΩÁä∂ÊÄÅÊåáÁ§∫Âô® */}
      {(isLoading || isCalculatingShadows) && (
        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
          <div className="bg-white bg-opacity-90 rounded-lg p-4 shadow-lg">
            <div className="flex items-center gap-3">
              <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              <span className="text-gray-700">
                {isLoading ? 'Ê≠£Âú®Âä†ËΩΩÂª∫Á≠ëÁâ©Êï∞ÊçÆ...' : 'Ê≠£Âú®ËÆ°ÁÆóÂÆûÊó∂Èò¥ÂΩ±...'}
              </span>
            </div>
          </div>
        </div>
      )}

      {/* Áä∂ÊÄÅ‰ø°ÊÅØ - Á°Æ‰øùÂú®ÊúÄÈ°∂Â±Ç */}
      <div className="absolute bottom-4 left-4 z-[9999]">
        <div className="bg-white bg-opacity-90 rounded px-3 py-2 shadow-lg">
          <div className="text-sm text-gray-700">
            <div>Ê®°Âºè: {is3D ? '3D' : '2D'} | Êï∞ÊçÆ: WFS</div>
            {shadowData && (
              <div>Âª∫Á≠ëÁâ©: {shadowData.buildingCount} | Èò¥ÂΩ±: {shadowData.shadows.length}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
