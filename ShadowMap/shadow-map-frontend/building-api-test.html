<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç­‘ç‰©APIæµ‹è¯•</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .info-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .test-results {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #d4edda;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ¢ å»ºç­‘ç‰©APIæµ‹è¯•é¡µé¢</h1>
    
    <div class="info-panel">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å»ºç­‘ç‰©æ•°æ®APIçš„é›†æˆã€‚ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ¥æµ‹è¯•ä¸åŒçš„APIç«¯ç‚¹ã€‚</p>
        <p><strong>åç«¯åœ°å€:</strong> http://localhost:3001</p>
    </div>

    <div id="map"></div>

    <div class="test-controls">
        <h3>APIæµ‹è¯•</h3>
        <button id="btn-info">æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API</button>
        <button id="btn-tile">æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API</button>
        <button id="btn-preload">æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API</button>
    </div>

    <div id="results" class="test-results">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="output">ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        let map;
        try {
            map = L.map('map').setView([39.9042, 116.4074], 15);
            
            // æ·»åŠ OpenStreetMapåº•å›¾
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // æ·»åŠ DEMç“¦ç‰‡å›¾å±‚ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            const demLayer = L.tileLayer('http://localhost:3001/api/dem/{z}/{x}/{y}.png', {
                attribution: 'DEM Data',
                opacity: 0.6
            }).addTo(map);
            
            console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
            // å³ä½¿åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼ŒAPIæµ‹è¯•åŠŸèƒ½ä»ç„¶å¯ä»¥å·¥ä½œ
        }

        // æ˜¾ç¤ºç»“æœçš„å‡½æ•°
        function showResult(title, data, isError = false) {
            const output = document.getElementById('output');
            const resultDiv = document.createElement('div');
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <pre>${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
                <small>æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}</small>
                <hr>
            `;
            
            if (isError) {
                resultDiv.className = 'error';
            }
            
            output.insertBefore(resultDiv, output.firstChild);
        }

        // æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API
        async function testBuildingInfo() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API...', 'è¯·æ±‚ä¸­...');
                
                const response = await fetch('http://localhost:3001/api/buildings/info');
                const data = await response.json();
                
                showResult('âœ… å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API
        async function testBuildingTile() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API...', 'è¯·æ±‚ä¸­...');
                
                // ä½¿ç”¨åŒ—äº¬å¸‚ä¸­å¿ƒçš„ç“¦ç‰‡åæ ‡
                const z = 16;
                const x = 53957;
                const y = 24832;
                
                const response = await fetch(`http://localhost:3001/api/buildings/${z}/${x}/${y}.json`);
                const data = await response.json();
                
                showResult(`âœ… å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•æˆåŠŸ (${z}/${x}/${y})`, {
                    tileInfo: data.tileInfo,
                    buildingCount: data.features.length,
                    bbox: data.bbox,
                    sampleBuilding: data.features[0] || 'æ— å»ºç­‘ç‰©æ•°æ®'
                });
                
                // å¦‚æœæœ‰å»ºç­‘ç‰©æ•°æ®ï¼Œåœ¨åœ°å›¾ä¸Šæ˜¾ç¤º
                if (data.features && data.features.length > 0 && map) {
                    try {
                        const geoJsonLayer = L.geoJSON(data, {
                            style: {
                                color: '#ff0000',
                                weight: 2,
                                fillOpacity: 0.3
                            },
                            onEachFeature: function(feature, layer) {
                                if (feature.properties) {
                                    layer.bindPopup(`
                                        <strong>å»ºç­‘ç‰©</strong><br>
                                        ç±»å‹: ${feature.properties.buildingType || 'æœªçŸ¥'}<br>
                                        é«˜åº¦: ${feature.properties.height || 'æœªçŸ¥'}m<br>
                                        æ¥¼å±‚: ${feature.properties.levels || 'æœªçŸ¥'}
                                    `);
                                }
                            }
                        }).addTo(map);
                    } catch (error) {
                        console.error('åœ°å›¾æ˜¾ç¤ºå»ºç­‘ç‰©å¤±è´¥:', error);
                    }
                }
                
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API
        async function testBuildingPreload() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API...', 'è¯·æ±‚ä¸­...');
                
                const lng = 116.4074;
                const lat = 39.9042;
                const radius = 1; // 1å…¬é‡Œ
                const zoom = 16;
                
                const response = await fetch(`http://localhost:3001/api/buildings/preload?lng=${lng}&lat=${lat}&radius=${radius}&zoom=${zoom}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                showResult('âœ… å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
        window.addEventListener('load', async () => {
            try {
                showResult('ğŸ”„ æ­£åœ¨æ£€æŸ¥åç«¯è¿æ¥...', 'è¯·æ±‚ä¸­...');
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                showResult('ğŸ¥ åç«¯å¥åº·æ£€æŸ¥', data);
            } catch (error) {
                showResult('âŒ åç«¯è¿æ¥å¤±è´¥', error.message, true);
            }
        });

        // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå·²åŠ è½½ï¼Œç»‘å®šäº‹ä»¶ç›‘å¬å™¨');
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            const btnInfo = document.getElementById('btn-info');
            const btnTile = document.getElementById('btn-tile');
            const btnPreload = document.getElementById('btn-preload');
            
            if (btnInfo) {
                btnInfo.addEventListener('click', testBuildingInfo);
                console.log('ä¿¡æ¯APIæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            if (btnTile) {
                btnTile.addEventListener('click', testBuildingTile);
                console.log('ç“¦ç‰‡APIæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            if (btnPreload) {
                btnPreload.addEventListener('click', testBuildingPreload);
                console.log('é¢„åŠ è½½APIæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
        });

        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('é¡µé¢é”™è¯¯:', event);
            showResult('âŒ JavaScripté”™è¯¯', `${event.message} (${event.filename}:${event.lineno})`, true);
        });

        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('å»ºç­‘ç‰©APIæµ‹è¯•é¡µé¢JavaScriptå·²åŠ è½½');
    </script>
</body>
</html>
