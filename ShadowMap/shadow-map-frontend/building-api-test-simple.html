<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化建筑物API测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #005a87;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007cba;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏢 简化建筑物API测试</h1>
        <p>这是一个不依赖Leaflet的简化测试页面，专注于API功能测试。</p>
        
        <div class="button-group">
            <button onclick="testJavaScript()">测试JavaScript</button>
            <button onclick="testHealthAPI()">测试健康检查API</button>
            <button onclick="testBuildingInfo()">测试建筑物信息API</button>
            <button onclick="testBuildingTile()">测试建筑物瓦片API</button>
            <button onclick="testBuildingPreload()">测试建筑物预加载API</button>
            <button onclick="testTumWFS()">测试TUM WFS服务</button>
            <button onclick="clearResults()">清除结果</button>
        </div>
        
        <div id="results">
            <h3>测试结果</h3>
            <div id="output">
                <div class="result">
                    <div class="status">准备就绪</div>
                    <p>点击上面的按钮开始测试API功能</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('简化测试页面JavaScript已加载');

        // 显示结果函数
        function showResult(title, data, isError = false) {
            console.log('显示结果:', title, data);
            const output = document.getElementById('output');
            const resultDiv = document.createElement('div');
            resultDiv.className = isError ? 'result error' : 'result success';
            
            const dataString = typeof data === 'object' ? 
                JSON.stringify(data, null, 2) : String(data);
            
            resultDiv.innerHTML = `
                <div class="status">${title}</div>
                <pre>${dataString}</pre>
                <small>测试时间: ${new Date().toLocaleString()}</small>
            `;
            
            output.insertBefore(resultDiv, output.firstChild);
        }

        // 基础JavaScript测试
        function testJavaScript() {
            console.log('testJavaScript() 被调用');
            showResult('✅ JavaScript功能正常', {
                message: 'JavaScript执行正常',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent.substring(0, 100) + '...'
            });
        }

        // 测试健康检查API
        async function testHealthAPI() {
            try {
                console.log('testHealthAPI() 被调用');
                showResult('🔄 正在测试健康检查API...', '发送请求中...');
                
                const response = await fetch('http://localhost:3001/api/health');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('健康检查API响应:', data);
                
                showResult('✅ 健康检查API测试成功', data);
            } catch (error) {
                console.error('健康检查API测试失败:', error);
                showResult('❌ 健康检查API测试失败', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // 测试建筑物信息API
        async function testBuildingInfo() {
            try {
                console.log('testBuildingInfo() 被调用');
                showResult('🔄 正在测试建筑物信息API...', '发送请求中...');
                
                const response = await fetch('http://localhost:3001/api/buildings/info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('建筑物信息API响应:', data);
                
                showResult('✅ 建筑物信息API测试成功', data);
            } catch (error) {
                console.error('建筑物信息API测试失败:', error);
                showResult('❌ 建筑物信息API测试失败', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // 测试建筑物瓦片API
        async function testBuildingTile() {
            try {
                console.log('testBuildingTile() 被调用');
                showResult('🔄 正在测试建筑物瓦片API...', '发送请求中...');
                
                const z = 16, x = 53957, y = 24832;
                const url = `http://localhost:3001/api/buildings/${z}/${x}/${y}.json`;
                console.log('请求URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('建筑物瓦片API响应:', data);
                
                // 简化显示的数据
                const summary = {
                    瓦片坐标: `${z}/${x}/${y}`,
                    建筑物数量: data.features ? data.features.length : 0,
                    边界框: data.bbox,
                    瓦片信息: data.tileInfo,
                    示例建筑: data.features && data.features[0] ? {
                        ID: data.features[0].properties?.id,
                        类型: data.features[0].properties?.buildingType,
                        高度: data.features[0].properties?.height
                    } : '无建筑物数据'
                };
                
                showResult(`✅ 建筑物瓦片API测试成功`, summary);
            } catch (error) {
                console.error('建筑物瓦片API测试失败:', error);
                showResult('❌ 建筑物瓦片API测试失败', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // 测试建筑物预加载API
        async function testBuildingPreload() {
            try {
                console.log('testBuildingPreload() 被调用');
                showResult('🔄 正在测试建筑物预加载API...', '发送请求中...');
                
                const requestData = {
                    lng: 116.4074,
                    lat: 39.9042,
                    radius: 1,
                    zoomLevel: 16
                };
                
                console.log('预加载请求数据:', requestData);
                
                const response = await fetch('http://localhost:3001/api/buildings/preload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('建筑物预加载API响应:', data);
                
                showResult('✅ 建筑物预加载API测试成功', data);
            } catch (error) {
                console.error('建筑物预加载API测试失败:', error);
                showResult('❌ 建筑物预加载API测试失败', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // 测试TUM WFS服务 - 更新为使用后端代理
        async function testTumWFS() {
            try {
                console.log('testTumWFS() 被调用');
                showResult('🔄 正在通过后端代理测试TUM WFS服务...', '发送请求中...');
                
                // 后端代理地址
                const proxyUrl = 'http://localhost:3001/api/tum-buildings/bounds';

                // 慕尼黑市中心区域的BBOX
                const munichBounds = {
                    north: 48.14,
                    south: 48.13,
                    east: 11.58,
                    west: 11.57,
                    maxFeatures: 50
                };
                
                console.log('请求后端代理URL:', proxyUrl);
                console.log('请求体:', munichBounds);
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(munichBounds)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
                
                const result = await response.json();
                console.log('后端代理响应:', result);

                if (!result.success) {
                    throw new Error(result.message || '后端返回操作失败');
                }
                
                const summary = {
                    请求URL: proxyUrl,
                    数据来源: result.metadata.source,
                    建筑物数量: result.data.features ? result.data.features.length : 0,
                    返回特征总数: result.metadata.numberReturned,
                    匹配特征总数: result.metadata.numberMatched,
                    坐标范围: result.metadata.bounds,
                    示例建筑: result.data.features && result.data.features[0] ? {
                        ID: result.data.features[0].properties?.id,
                        高度: result.data.features[0].properties?.height,
                        类型: result.data.features[0].properties?.buildingType
                    } : '无建筑物数据'
                };
                
                showResult(`✅ TUM WFS代理测试成功`, summary);
            } catch (error) {
                console.error('TUM WFS代理测试失败:', error);
                showResult('❌ TUM WFS代理测试失败', {
                    error: error.message,
                    type: error.constructor.name,
                    suggestion: '请确保后端服务已启动，并检查浏览器和后端控制台的日志。'
                }, true);
            }
        }

        // 清除结果
        function clearResults() {
            console.log('clearResults() 被调用');
            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="result">
                    <div class="status">结果已清除</div>
                    <p>点击上面的按钮开始新的测试</p>
                </div>
            `;
        }

        // 页面加载完成事件
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM已加载完成');
            showResult('🎉 页面初始化完成', {
                message: '简化测试页面准备就绪',
                timestamp: new Date().toISOString()
            });
        });

        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('页面发生错误:', event);
            showResult('❌ 页面错误', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            }, true);
        });

        // 未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未处理的Promise拒绝:', event);
            showResult('❌ 异步错误', {
                reason: event.reason?.message || event.reason,
                type: 'UnhandledPromiseRejection'
            }, true);
        });
    </script>
</body>
</html>
