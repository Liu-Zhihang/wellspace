<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–å»ºç­‘ç‰©APIæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #005a87;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007cba;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ ç®€åŒ–å»ºç­‘ç‰©APIæµ‹è¯•</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªä¸ä¾èµ–Leafletçš„ç®€åŒ–æµ‹è¯•é¡µé¢ï¼Œä¸“æ³¨äºAPIåŠŸèƒ½æµ‹è¯•ã€‚</p>
        
        <div class="button-group">
            <button onclick="testJavaScript()">æµ‹è¯•JavaScript</button>
            <button onclick="testHealthAPI()">æµ‹è¯•å¥åº·æ£€æŸ¥API</button>
            <button onclick="testBuildingInfo()">æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API</button>
            <button onclick="testBuildingTile()">æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API</button>
            <button onclick="testBuildingPreload()">æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API</button>
            <button onclick="testTumWFS()">æµ‹è¯•TUM WFSæœåŠ¡</button>
            <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div id="results">
            <h3>æµ‹è¯•ç»“æœ</h3>
            <div id="output">
                <div class="result">
                    <div class="status">å‡†å¤‡å°±ç»ª</div>
                    <p>ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•APIåŠŸèƒ½</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ç®€åŒ–æµ‹è¯•é¡µé¢JavaScriptå·²åŠ è½½');

        // æ˜¾ç¤ºç»“æœå‡½æ•°
        function showResult(title, data, isError = false) {
            console.log('æ˜¾ç¤ºç»“æœ:', title, data);
            const output = document.getElementById('output');
            const resultDiv = document.createElement('div');
            resultDiv.className = isError ? 'result error' : 'result success';
            
            const dataString = typeof data === 'object' ? 
                JSON.stringify(data, null, 2) : String(data);
            
            resultDiv.innerHTML = `
                <div class="status">${title}</div>
                <pre>${dataString}</pre>
                <small>æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}</small>
            `;
            
            output.insertBefore(resultDiv, output.firstChild);
        }

        // åŸºç¡€JavaScriptæµ‹è¯•
        function testJavaScript() {
            console.log('testJavaScript() è¢«è°ƒç”¨');
            showResult('âœ… JavaScriptåŠŸèƒ½æ­£å¸¸', {
                message: 'JavaScriptæ‰§è¡Œæ­£å¸¸',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent.substring(0, 100) + '...'
            });
        }

        // æµ‹è¯•å¥åº·æ£€æŸ¥API
        async function testHealthAPI() {
            try {
                console.log('testHealthAPI() è¢«è°ƒç”¨');
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å¥åº·æ£€æŸ¥API...', 'å‘é€è¯·æ±‚ä¸­...');
                
                const response = await fetch('http://localhost:3001/api/health');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å¥åº·æ£€æŸ¥APIå“åº”:', data);
                
                showResult('âœ… å¥åº·æ£€æŸ¥APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                console.error('å¥åº·æ£€æŸ¥APIæµ‹è¯•å¤±è´¥:', error);
                showResult('âŒ å¥åº·æ£€æŸ¥APIæµ‹è¯•å¤±è´¥', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API
        async function testBuildingInfo() {
            try {
                console.log('testBuildingInfo() è¢«è°ƒç”¨');
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API...', 'å‘é€è¯·æ±‚ä¸­...');
                
                const response = await fetch('http://localhost:3001/api/buildings/info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å»ºç­‘ç‰©ä¿¡æ¯APIå“åº”:', data);
                
                showResult('âœ… å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                console.error('å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•å¤±è´¥:', error);
                showResult('âŒ å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•å¤±è´¥', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API
        async function testBuildingTile() {
            try {
                console.log('testBuildingTile() è¢«è°ƒç”¨');
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API...', 'å‘é€è¯·æ±‚ä¸­...');
                
                const z = 16, x = 53957, y = 24832;
                const url = `http://localhost:3001/api/buildings/${z}/${x}/${y}.json`;
                console.log('è¯·æ±‚URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å»ºç­‘ç‰©ç“¦ç‰‡APIå“åº”:', data);
                
                // ç®€åŒ–æ˜¾ç¤ºçš„æ•°æ®
                const summary = {
                    ç“¦ç‰‡åæ ‡: `${z}/${x}/${y}`,
                    å»ºç­‘ç‰©æ•°é‡: data.features ? data.features.length : 0,
                    è¾¹ç•Œæ¡†: data.bbox,
                    ç“¦ç‰‡ä¿¡æ¯: data.tileInfo,
                    ç¤ºä¾‹å»ºç­‘: data.features && data.features[0] ? {
                        ID: data.features[0].properties?.id,
                        ç±»å‹: data.features[0].properties?.buildingType,
                        é«˜åº¦: data.features[0].properties?.height
                    } : 'æ— å»ºç­‘ç‰©æ•°æ®'
                };
                
                showResult(`âœ… å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•æˆåŠŸ`, summary);
            } catch (error) {
                console.error('å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•å¤±è´¥:', error);
                showResult('âŒ å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•å¤±è´¥', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API
        async function testBuildingPreload() {
            try {
                console.log('testBuildingPreload() è¢«è°ƒç”¨');
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API...', 'å‘é€è¯·æ±‚ä¸­...');
                
                const requestData = {
                    lng: 116.4074,
                    lat: 39.9042,
                    radius: 1,
                    zoomLevel: 16
                };
                
                console.log('é¢„åŠ è½½è¯·æ±‚æ•°æ®:', requestData);
                
                const response = await fetch('http://localhost:3001/api/buildings/preload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('å»ºç­‘ç‰©é¢„åŠ è½½APIå“åº”:', data);
                
                showResult('âœ… å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                console.error('å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•å¤±è´¥:', error);
                showResult('âŒ å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•å¤±è´¥', {
                    error: error.message,
                    type: error.constructor.name
                }, true);
            }
        }

        // æµ‹è¯•TUM WFSæœåŠ¡ - æ›´æ–°ä¸ºä½¿ç”¨åç«¯ä»£ç†
        async function testTumWFS() {
            try {
                console.log('testTumWFS() è¢«è°ƒç”¨');
                showResult('ğŸ”„ æ­£åœ¨é€šè¿‡åç«¯ä»£ç†æµ‹è¯•TUM WFSæœåŠ¡...', 'å‘é€è¯·æ±‚ä¸­...');
                
                // åç«¯ä»£ç†åœ°å€
                const proxyUrl = 'http://localhost:3001/api/tum-buildings/bounds';

                // æ…•å°¼é»‘å¸‚ä¸­å¿ƒåŒºåŸŸçš„BBOX
                const munichBounds = {
                    north: 48.14,
                    south: 48.13,
                    east: 11.58,
                    west: 11.57,
                    maxFeatures: 50
                };
                
                console.log('è¯·æ±‚åç«¯ä»£ç†URL:', proxyUrl);
                console.log('è¯·æ±‚ä½“:', munichBounds);
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(munichBounds)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
                
                const result = await response.json();
                console.log('åç«¯ä»£ç†å“åº”:', result);

                if (!result.success) {
                    throw new Error(result.message || 'åç«¯è¿”å›æ“ä½œå¤±è´¥');
                }
                
                const summary = {
                    è¯·æ±‚URL: proxyUrl,
                    æ•°æ®æ¥æº: result.metadata.source,
                    å»ºç­‘ç‰©æ•°é‡: result.data.features ? result.data.features.length : 0,
                    è¿”å›ç‰¹å¾æ€»æ•°: result.metadata.numberReturned,
                    åŒ¹é…ç‰¹å¾æ€»æ•°: result.metadata.numberMatched,
                    åæ ‡èŒƒå›´: result.metadata.bounds,
                    ç¤ºä¾‹å»ºç­‘: result.data.features && result.data.features[0] ? {
                        ID: result.data.features[0].properties?.id,
                        é«˜åº¦: result.data.features[0].properties?.height,
                        ç±»å‹: result.data.features[0].properties?.buildingType
                    } : 'æ— å»ºç­‘ç‰©æ•°æ®'
                };
                
                showResult(`âœ… TUM WFSä»£ç†æµ‹è¯•æˆåŠŸ`, summary);
            } catch (error) {
                console.error('TUM WFSä»£ç†æµ‹è¯•å¤±è´¥:', error);
                showResult('âŒ TUM WFSä»£ç†æµ‹è¯•å¤±è´¥', {
                    error: error.message,
                    type: error.constructor.name,
                    suggestion: 'è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼Œå¹¶æ£€æŸ¥æµè§ˆå™¨å’Œåç«¯æ§åˆ¶å°çš„æ—¥å¿—ã€‚'
                }, true);
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            console.log('clearResults() è¢«è°ƒç”¨');
            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="result">
                    <div class="status">ç»“æœå·²æ¸…é™¤</div>
                    <p>ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æ–°çš„æµ‹è¯•</p>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå·²åŠ è½½å®Œæˆ');
            showResult('ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ', {
                message: 'ç®€åŒ–æµ‹è¯•é¡µé¢å‡†å¤‡å°±ç»ª',
                timestamp: new Date().toISOString()
            });
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('é¡µé¢å‘ç”Ÿé”™è¯¯:', event);
            showResult('âŒ é¡µé¢é”™è¯¯', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            }, true);
        });

        // æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event);
            showResult('âŒ å¼‚æ­¥é”™è¯¯', {
                reason: event.reason?.message || event.reason,
                type: 'UnhandledPromiseRejection'
            }, true);
        });
    </script>
</body>
</html>
