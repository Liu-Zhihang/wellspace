<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç­‘ç‰©APIæµ‹è¯• - æ”¹è¿›ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .panel-content {
            padding: 20px;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .test-result {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            background: #ecf0f1;
        }

        .test-result.success {
            border-left-color: #27ae60;
            background: #d5edda;
        }

        .test-result.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }

        .test-result h4 {
            margin: 0 0 10px 0;
        }

        .test-result pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #34495e;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .legend {
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>ğŸ¢ å»ºç­‘ç‰©APIæµ‹è¯• - æ”¹è¿›ç‰ˆ</h1>
    
    <div class="container">
        <!-- åœ°å›¾é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">ğŸ“ äº¤äº’å¼åœ°å›¾</div>
            <div class="panel-content">
                <div class="button-group">
                    <button onclick="loadBuildingsAtCurrentView()">åŠ è½½å½“å‰è§†å›¾å»ºç­‘ç‰©</button>
                    <button onclick="clearAllLayers()">æ¸…é™¤æ‰€æœ‰å›¾å±‚</button>
                    <button onclick="goToBeijing()">è·³è½¬åˆ°åŒ—äº¬</button>
                    <button onclick="goToShanghai()">è·³è½¬åˆ°ä¸Šæµ·</button>
                </div>
                
                <div id="map"></div>
                
                <div class="legend">
                    <h4>å›¾ä¾‹</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(255,0,0,0.3); border-color: #ff0000;"></div>
                        <span>å»ºç­‘ç‰©å¤šè¾¹å½¢</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(0,100,255,0.3); border-color: #0064ff;"></div>
                        <span>é«˜å±‚å»ºç­‘ (>20m)</span>
                    </div>
                </div>

                <div class="stats" id="mapStats">
                    <div class="stat-item">
                        <div class="stat-value" id="buildingCount">0</div>
                        <div class="stat-label">å»ºç­‘ç‰©æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tileCount">0</div>
                        <div class="stat-label">åŠ è½½ç“¦ç‰‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgHeight">0</div>
                        <div class="stat-label">å¹³å‡é«˜åº¦(m)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">ğŸ§ª APIæµ‹è¯•</div>
            <div class="panel-content">
                <div class="button-group">
                    <button onclick="testBuildingInfo()">æµ‹è¯•æœåŠ¡ä¿¡æ¯</button>
                    <button onclick="testBuildingTile()">æµ‹è¯•ç“¦ç‰‡API</button>
                    <button onclick="testBuildingPreload()">æµ‹è¯•é¢„åŠ è½½</button>
                    <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
                </div>
                
                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map').setView([39.9042, 116.4074], 15);
        
        // æ·»åŠ åº•å›¾
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // å›¾å±‚ç®¡ç†
        let buildingLayers = L.layerGroup().addTo(map);
        let totalBuildings = 0;
        let totalTiles = 0;
        let totalHeight = 0;

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(title, data, isError = false) {
            const output = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isError ? 'error' : 'success'}`;
            
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <pre>${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
                <small>æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}</small>
            `;
            
            output.insertBefore(resultDiv, output.firstChild);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('buildingCount').textContent = totalBuildings;
            document.getElementById('tileCount').textContent = totalTiles;
            document.getElementById('avgHeight').textContent = totalBuildings > 0 ? Math.round(totalHeight / totalBuildings) : 0;
        }

        // æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API
        async function testBuildingInfo() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ä¿¡æ¯API...', 'è¯·æ±‚ä¸­...');
                
                const response = await fetch('http://localhost:3001/api/buildings/info');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult('âœ… å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©ä¿¡æ¯APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API
        async function testBuildingTile() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©ç“¦ç‰‡API...', 'è¯·æ±‚ä¸­...');
                
                // ä½¿ç”¨åŒ—äº¬å¸‚ä¸­å¿ƒçš„ç“¦ç‰‡åæ ‡
                const z = 16;
                const x = 53957;
                const y = 24832;
                
                const response = await fetch(`http://localhost:3001/api/buildings/${z}/${x}/${y}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult(`âœ… å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•æˆåŠŸ (${z}/${x}/${y})`, {
                    tileInfo: data.tileInfo,
                    buildingCount: data.features.length,
                    bbox: data.bbox,
                    sampleBuilding: data.features[0] || 'æ— å»ºç­‘ç‰©æ•°æ®'
                });
                
                // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå»ºç­‘ç‰©
                loadBuildingData(data);
                
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©ç“¦ç‰‡APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API
        async function testBuildingPreload() {
            try {
                showResult('ğŸ”„ æ­£åœ¨æµ‹è¯•å»ºç­‘ç‰©é¢„åŠ è½½API...', 'è¯·æ±‚ä¸­...');
                
                const lng = 116.4074;
                const lat = 39.9042;
                const radius = 1; // 1å…¬é‡Œ
                const zoom = 16;
                
                const response = await fetch('http://localhost:3001/api/buildings/preload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lng: lng,
                        lat: lat,
                        radius: radius,
                        zoomLevel: zoom
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                showResult('âœ… å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•æˆåŠŸ', data);
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©é¢„åŠ è½½APIæµ‹è¯•å¤±è´¥', error.message, true);
            }
        }

        // åŠ è½½å»ºç­‘ç‰©æ•°æ®åˆ°åœ°å›¾
        function loadBuildingData(geoJsonData) {
            const geoJsonLayer = L.geoJSON(geoJsonData, {
                style: function(feature) {
                    const height = feature.properties.height || 10;
                    const isHighRise = height > 20;
                    
                    return {
                        color: isHighRise ? '#0064ff' : '#ff0000',
                        weight: 2,
                        fillOpacity: 0.4,
                        fillColor: isHighRise ? '#0064ff' : '#ff0000'
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        const props = feature.properties;
                        layer.bindPopup(`
                            <div style="min-width: 200px;">
                                <h4>ğŸ¢ å»ºç­‘ç‰©è¯¦æƒ…</h4>
                                <p><strong>ID:</strong> ${props.id || 'æœªçŸ¥'}</p>
                                <p><strong>ç±»å‹:</strong> ${props.buildingType || 'æœªçŸ¥'}</p>
                                <p><strong>é«˜åº¦:</strong> ${props.height || 'æœªçŸ¥'}m</p>
                                <p><strong>æ¥¼å±‚:</strong> ${props.levels || 'æœªçŸ¥'}</p>
                            </div>
                        `);
                        
                        // æ›´æ–°ç»Ÿè®¡
                        totalBuildings++;
                        totalHeight += (props.height || 10);
                    }
                }
            });
            
            buildingLayers.addLayer(geoJsonLayer);
            totalTiles++;
            updateStats();
            
            // è°ƒæ•´åœ°å›¾è§†å›¾åˆ°å»ºç­‘ç‰©èŒƒå›´
            if (geoJsonData.features && geoJsonData.features.length > 0) {
                map.fitBounds(geoJsonLayer.getBounds(), { padding: [20, 20] });
            }
        }

        // åŠ è½½å½“å‰è§†å›¾çš„å»ºç­‘ç‰©
        async function loadBuildingsAtCurrentView() {
            const bounds = map.getBounds();
            const zoom = Math.min(Math.max(map.getZoom(), 14), 17);
            
            try {
                showResult('ğŸ”„ æ­£åœ¨åŠ è½½å½“å‰è§†å›¾çš„å»ºç­‘ç‰©...', `ç¼©æ”¾çº§åˆ«: ${zoom}`);
                
                // è®¡ç®—å½“å‰è§†å›¾éœ€è¦çš„ç“¦ç‰‡
                const tiles = getTilesInBounds(bounds, zoom);
                
                for (const tile of tiles) {
                    const response = await fetch(`http://localhost:3001/api/buildings/${tile.z}/${tile.x}/${tile.y}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        loadBuildingData(data);
                    }
                }
                
                showResult('âœ… å»ºç­‘ç‰©åŠ è½½å®Œæˆ', `åŠ è½½äº† ${tiles.length} ä¸ªç“¦ç‰‡`);
                
            } catch (error) {
                showResult('âŒ å»ºç­‘ç‰©åŠ è½½å¤±è´¥', error.message, true);
            }
        }

        // è®¡ç®—è¾¹ç•Œæ¡†å†…çš„ç“¦ç‰‡
        function getTilesInBounds(bounds, zoom) {
            const tiles = [];
            const nw = bounds.getNorthWest();
            const se = bounds.getSouthEast();
            
            const minTile = latLngToTile(nw.lat, nw.lng, zoom);
            const maxTile = latLngToTile(se.lat, se.lng, zoom);
            
            for (let x = minTile.x; x <= maxTile.x; x++) {
                for (let y = minTile.y; y <= maxTile.y; y++) {
                    tiles.push({ z: zoom, x: x, y: y });
                }
            }
            
            return tiles;
        }

        // ç»çº¬åº¦è½¬ç“¦ç‰‡åæ ‡
        function latLngToTile(lat, lng, zoom) {
            const n = Math.pow(2, zoom);
            const x = Math.floor((lng + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(lat * Math.PI / 180)) / Math.PI) / 2 * n);
            return { x, y };
        }

        // æ¸…é™¤æ‰€æœ‰å›¾å±‚
        function clearAllLayers() {
            buildingLayers.clearLayers();
            totalBuildings = 0;
            totalTiles = 0;
            totalHeight = 0;
            updateStats();
            showResult('ğŸ§¹ å›¾å±‚å·²æ¸…é™¤', 'æ‰€æœ‰å»ºç­‘ç‰©å›¾å±‚å·²ç§»é™¤');
        }

        // æ¸…é™¤æµ‹è¯•ç»“æœ
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // è·³è½¬åˆ°æŒ‡å®šåŸå¸‚
        function goToBeijing() {
            map.setView([39.9042, 116.4074], 15);
        }

        function goToShanghai() {
            map.setView([31.2304, 121.4737], 15);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                showResult('ğŸ¥ åç«¯å¥åº·æ£€æŸ¥', data);
            } catch (error) {
                showResult('âŒ åç«¯è¿æ¥å¤±è´¥', 'è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨åœ¨è¿è¡Œ (http://localhost:3001)', true);
            }
        });
    </script>
</body>
</html>
