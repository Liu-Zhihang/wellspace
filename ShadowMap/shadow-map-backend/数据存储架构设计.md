# ShadowMap 数据存储架构设计

## 📊 数据分类和存储策略

### 🗄️ 需要MongoDB存储的数据

#### 1. 🏢 **建筑物数据** (核心数据)
**存储原因**：频繁查询、地理空间索引、缓存优化
```javascript
// Collection: buildings
{
  _id: ObjectId,
  geometry: {
    type: "Polygon",
    coordinates: [[[lng, lat], ...]]
  },
  properties: {
    id: "way_227192080",
    buildingType: "residential",
    height: 25.5,
    levels: 8,
    area: 156.7,
    osm_id: "227192080"
  },
  tile: { z: 15, x: 26976, y: 13487 },
  bbox: [116.394, 39.905, 116.400, 39.909],
  metadata: {
    data_source: "osm",
    quality_score: 0.85,
    last_verified: ISODate
  },
  created_at: ISODate,
  last_updated: ISODate
}
```

#### 2. 🗺️ **DEM瓦片元数据** (缓存管理)
**存储原因**：瓦片状态跟踪、访问统计、缓存优化
```javascript
// Collection: dem_tiles
{
  _id: "15/26976/13487",
  z: 15, x: 26976, y: 13487,
  bounds: [116.394, 39.905, 116.400, 39.909],
  file_info: {
    path: "/data/dem/15/26976/13487.png",
    size: 65536,
    checksum: "a1b2c3d4e5f6",
    format: "png"
  },
  elevation_stats: {
    min_elevation: 45.2,
    max_elevation: 156.8,
    avg_elevation: 78.5
  },
  cache_info: {
    cached: true,
    source: "aws_terrarium",
    download_url: "https://...",
    last_accessed: ISODate,
    access_count: 156
  },
  created_at: ISODate
}
```

#### 3. 🚶‍♂️ **用户轨迹数据** (出行分析核心)
**存储原因**：复杂分析、历史记录、个性化推荐
```javascript
// Collection: user_tracks
{
  _id: ObjectId,
  user_id: "user_123",
  track_info: {
    name: "早晨跑步路线",
    description: "从家到公园的晨跑",
    activity_type: "running",
    privacy: "private" // private, public, friends
  },
  route: {
    type: "LineString",
    coordinates: [[lng, lat, timestamp, elevation], ...]
  },
  gps_points: [{
    lng: 116.397,
    lat: 39.908,
    timestamp: ISODate,
    altitude: 78.5,
    accuracy: 5.0,
    speed: 2.5
  }],
  shadow_analysis: {
    total_distance: 2500,
    total_duration: 1800, // 秒
    sunlight_exposure: {
      total_minutes: 25,
      shadow_minutes: 5,
      shadow_ratio: 0.2
    },
    uv_analysis: {
      total_uv_exposure: 4.2,
      peak_uv_time: ISODate,
      uv_dose_rate: 0.14
    },
    comfort_metrics: {
      comfort_score: 7.5, // 1-10
      temperature_avg: 22.5,
      humidity_avg: 65,
      wind_speed_avg: 2.1
    },
    shadow_segments: [{
      start_time: ISODate,
      end_time: ISODate,
      shadow_ratio: 0.8,
      segment_length: 150,
      dominant_shade_source: "building" // building, tree, terrain
    }]
  },
  weather_data: {
    conditions: "partly_cloudy",
    cloud_cover: 0.3,
    temperature: 23,
    humidity: 68,
    wind_speed: 2.2,
    uv_index: 6
  },
  created_at: ISODate,
  analyzed_at: ISODate
}
```

#### 4. 👤 **用户数据和偏好** (个性化)
**存储原因**：用户管理、偏好设置、个性化推荐
```javascript
// Collection: users
{
  _id: ObjectId,
  user_id: "user_123",
  profile: {
    username: "shadow_runner",
    email: "user@example.com",
    avatar_url: "https://...",
    created_at: ISODate
  },
  preferences: {
    shadow_sensitivity: "high", // low, medium, high
    preferred_activities: ["walking", "running"],
    max_uv_exposure: 5.0,
    comfort_temperature_range: [18, 25],
    notification_settings: {
      route_suggestions: true,
      weather_alerts: true,
      uv_warnings: true
    }
  },
  statistics: {
    total_tracks: 156,
    total_distance: 125600, // 米
    total_time: 89400, // 秒
    avg_comfort_score: 7.2,
    favorite_routes: [ObjectId, ...],
    achievement_badges: ["early_bird", "shadow_seeker"]
  },
  last_active: ISODate
}
```

#### 5. 🌤️ **天气数据缓存** (性能优化)
**存储原因**：减少外部API调用、历史数据分析
```javascript
// Collection: weather_cache
{
  _id: ObjectId,
  location: {
    type: "Point",
    coordinates: [lng, lat]
  },
  grid_cell: "39_116", // 简化的网格标识
  timestamp: ISODate,
  data: {
    temperature: 23.5,
    humidity: 65,
    cloud_cover: 0.3,
    uv_index: 6,
    wind_speed: 2.2,
    wind_direction: 180,
    visibility: 10000,
    precipitation: 0
  },
  source: "nullschool.net",
  expires_at: ISODate,
  created_at: ISODate
}
```

#### 6. 🛣️ **路线推荐数据** (智能推荐)
**存储原因**：预计算路线、推荐算法、用户反馈
```javascript
// Collection: route_recommendations
{
  _id: ObjectId,
  origin: {
    type: "Point",
    coordinates: [lng, lat],
    address: "北京市朝阳区..."
  },
  destination: {
    type: "Point", 
    coordinates: [lng, lat],
    address: "北京市海淀区..."
  },
  route_options: [{
    route_id: "route_001",
    geometry: {
      type: "LineString",
      coordinates: [[lng, lat], ...]
    },
    metrics: {
      total_distance: 2500,
      estimated_time: 30, // 分钟
      shadow_coverage: 0.75, // 阴影覆盖率
      comfort_score: 8.2,
      uv_exposure: 2.1
    },
    optimization_target: "min_sun_exposure", // min_sun_exposure, max_comfort, fastest
    weather_conditions: {
      optimal_times: ["08:00-10:00", "16:00-18:00"],
      avoid_times: ["12:00-14:00"]
    }
  }],
  popularity: {
    usage_count: 45,
    avg_rating: 4.2,
    last_used: ISODate
  },
  created_at: ISODate,
  expires_at: ISODate
}
```

### 📁 **不需要MongoDB存储的数据**

#### 1. 🖼️ **DEM瓦片文件本身**
- **存储位置**：文件系统 + CDN
- **原因**：二进制数据、大文件、适合CDN缓存
- **访问方式**：直接HTTP请求

#### 2. 🎨 **前端静态资源**
- **存储位置**：CDN
- **包含**：JS、CSS、图片、字体
- **原因**：静态内容、全球分发

#### 3. 📊 **实时计算结果**
- **存储位置**：内存缓存（Redis）
- **包含**：临时阴影计算、实时天气
- **原因**：短期有效、频繁更新

## 🔍 数据访问模式设计

### 1. **建筑物数据访问**
```typescript
// 按瓦片查询（最常用）
GET /api/buildings/tile/{z}/{x}/{y}
// 实现：tile索引 + 地理空间查询

// 按区域查询
GET /api/buildings/bounds?west=116.3&south=39.9&east=116.4&north=40.0
// 实现：2dsphere索引

// 按建筑类型查询
GET /api/buildings/type/residential?bounds=...
// 实现：buildingType索引 + 地理空间查询
```

### 2. **用户轨迹数据访问**
```typescript
// 用户的所有轨迹
GET /api/tracks/user/{user_id}
// 实现：user_id索引

// 公开的轨迹（社区功能）
GET /api/tracks/public?activity=running&comfort_min=7
// 实现：privacy + activity_type + comfort_score索引

// 区域内的轨迹
GET /api/tracks/area?bounds=...
// 实现：route地理空间索引
```

### 3. **路线推荐访问**
```typescript
// 获取路线推荐
POST /api/routes/recommend
{
  "origin": [lng, lat],
  "destination": [lng, lat], 
  "preferences": {
    "optimization": "min_sun_exposure",
    "activity": "walking"
  }
}
// 实现：地理空间查询 + 缓存策略
```

## 🚀 高性能访问策略

### 1. **索引优化**
```javascript
// 地理空间索引
db.buildings.createIndex({ "geometry": "2dsphere" })
db.user_tracks.createIndex({ "route": "2dsphere" })
db.weather_cache.createIndex({ "location": "2dsphere" })

// 复合索引
db.buildings.createIndex({ 
  "tile.z": 1, 
  "tile.x": 1, 
  "tile.y": 1,
  "properties.height": -1 
})

// 时间序列索引
db.user_tracks.createIndex({ "user_id": 1, "created_at": -1 })
db.weather_cache.createIndex({ "expires_at": 1 }, { expireAfterSeconds: 0 })
```

### 2. **缓存策略**
```typescript
// 多级缓存架构
const cacheStrategy = {
  // L1: 内存缓存（最热数据）
  memory: {
    buildingTiles: "5 minutes",
    weatherData: "2 minutes"
  },
  
  // L2: MongoDB（持久化缓存）
  mongodb: {
    buildings: "30 days",
    demMetadata: "永久",
    weatherCache: "6 hours"
  },
  
  // L3: 外部API（最后选择）
  external: {
    osmApi: "实时获取",
    weatherApi: "实时获取"
  }
};
```

### 3. **分页和限制**
```typescript
// 大数据集分页
const paginationConfig = {
  defaultLimit: 50,
  maxLimit: 1000,
  cursorBased: true, // 使用cursor分页而非offset
  
  // 示例API
  // GET /api/tracks?cursor=ObjectId&limit=50
};
```

## 📈 数据增长预估

### 容量规划
```javascript
const dataGrowthEstimate = {
  buildings: {
    recordSize: "2KB per building",
    globalEstimate: "100M buildings = 200GB",
    hotCities: "10M buildings = 20GB",
    growth: "10% per year"
  },
  
  userTracks: {
    recordSize: "5KB per track", 
    dailyTracks: "1000 tracks/day = 5MB/day",
    yearlyGrowth: "1.8GB per year",
    retention: "Keep all data (historical analysis)"
  },
  
  weatherCache: {
    recordSize: "1KB per record",
    coverage: "Global grid 1km = 510M records = 510GB",
    actualUsage: "Hot areas only = 10GB",
    ttl: "6 hours (auto cleanup)"
  }
};
```

这个数据架构设计为ShadowMap项目提供了：
- 🏃‍♂️ **高性能**：优化的索引和查询模式
- 🌍 **可扩展**：支持全球数据和大量用户
- 🧠 **智能化**：支持复杂的出行分析和推荐
- 💾 **经济性**：合理的存储策略和数据生命周期管理
