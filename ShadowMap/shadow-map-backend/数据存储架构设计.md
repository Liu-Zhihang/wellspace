# ShadowMap æ•°æ®å­˜å‚¨æ¶æ„è®¾è®¡

## ğŸ“Š æ•°æ®åˆ†ç±»å’Œå­˜å‚¨ç­–ç•¥

### ğŸ—„ï¸ éœ€è¦MongoDBå­˜å‚¨çš„æ•°æ®

#### 1. ğŸ¢ **å»ºç­‘ç‰©æ•°æ®** (æ ¸å¿ƒæ•°æ®)
**å­˜å‚¨åŸå› **ï¼šé¢‘ç¹æŸ¥è¯¢ã€åœ°ç†ç©ºé—´ç´¢å¼•ã€ç¼“å­˜ä¼˜åŒ–
```javascript
// Collection: buildings
{
  _id: ObjectId,
  geometry: {
    type: "Polygon",
    coordinates: [[[lng, lat], ...]]
  },
  properties: {
    id: "way_227192080",
    buildingType: "residential",
    height: 25.5,
    levels: 8,
    area: 156.7,
    osm_id: "227192080"
  },
  tile: { z: 15, x: 26976, y: 13487 },
  bbox: [116.394, 39.905, 116.400, 39.909],
  metadata: {
    data_source: "osm",
    quality_score: 0.85,
    last_verified: ISODate
  },
  created_at: ISODate,
  last_updated: ISODate
}
```

#### 2. ğŸ—ºï¸ **DEMç“¦ç‰‡å…ƒæ•°æ®** (ç¼“å­˜ç®¡ç†)
**å­˜å‚¨åŸå› **ï¼šç“¦ç‰‡çŠ¶æ€è·Ÿè¸ªã€è®¿é—®ç»Ÿè®¡ã€ç¼“å­˜ä¼˜åŒ–
```javascript
// Collection: dem_tiles
{
  _id: "15/26976/13487",
  z: 15, x: 26976, y: 13487,
  bounds: [116.394, 39.905, 116.400, 39.909],
  file_info: {
    path: "/data/dem/15/26976/13487.png",
    size: 65536,
    checksum: "a1b2c3d4e5f6",
    format: "png"
  },
  elevation_stats: {
    min_elevation: 45.2,
    max_elevation: 156.8,
    avg_elevation: 78.5
  },
  cache_info: {
    cached: true,
    source: "aws_terrarium",
    download_url: "https://...",
    last_accessed: ISODate,
    access_count: 156
  },
  created_at: ISODate
}
```

#### 3. ğŸš¶â€â™‚ï¸ **ç”¨æˆ·è½¨è¿¹æ•°æ®** (å‡ºè¡Œåˆ†ææ ¸å¿ƒ)
**å­˜å‚¨åŸå› **ï¼šå¤æ‚åˆ†æã€å†å²è®°å½•ã€ä¸ªæ€§åŒ–æ¨è
```javascript
// Collection: user_tracks
{
  _id: ObjectId,
  user_id: "user_123",
  track_info: {
    name: "æ—©æ™¨è·‘æ­¥è·¯çº¿",
    description: "ä»å®¶åˆ°å…¬å›­çš„æ™¨è·‘",
    activity_type: "running",
    privacy: "private" // private, public, friends
  },
  route: {
    type: "LineString",
    coordinates: [[lng, lat, timestamp, elevation], ...]
  },
  gps_points: [{
    lng: 116.397,
    lat: 39.908,
    timestamp: ISODate,
    altitude: 78.5,
    accuracy: 5.0,
    speed: 2.5
  }],
  shadow_analysis: {
    total_distance: 2500,
    total_duration: 1800, // ç§’
    sunlight_exposure: {
      total_minutes: 25,
      shadow_minutes: 5,
      shadow_ratio: 0.2
    },
    uv_analysis: {
      total_uv_exposure: 4.2,
      peak_uv_time: ISODate,
      uv_dose_rate: 0.14
    },
    comfort_metrics: {
      comfort_score: 7.5, // 1-10
      temperature_avg: 22.5,
      humidity_avg: 65,
      wind_speed_avg: 2.1
    },
    shadow_segments: [{
      start_time: ISODate,
      end_time: ISODate,
      shadow_ratio: 0.8,
      segment_length: 150,
      dominant_shade_source: "building" // building, tree, terrain
    }]
  },
  weather_data: {
    conditions: "partly_cloudy",
    cloud_cover: 0.3,
    temperature: 23,
    humidity: 68,
    wind_speed: 2.2,
    uv_index: 6
  },
  created_at: ISODate,
  analyzed_at: ISODate
}
```

#### 4. ğŸ‘¤ **ç”¨æˆ·æ•°æ®å’Œåå¥½** (ä¸ªæ€§åŒ–)
**å­˜å‚¨åŸå› **ï¼šç”¨æˆ·ç®¡ç†ã€åå¥½è®¾ç½®ã€ä¸ªæ€§åŒ–æ¨è
```javascript
// Collection: users
{
  _id: ObjectId,
  user_id: "user_123",
  profile: {
    username: "shadow_runner",
    email: "user@example.com",
    avatar_url: "https://...",
    created_at: ISODate
  },
  preferences: {
    shadow_sensitivity: "high", // low, medium, high
    preferred_activities: ["walking", "running"],
    max_uv_exposure: 5.0,
    comfort_temperature_range: [18, 25],
    notification_settings: {
      route_suggestions: true,
      weather_alerts: true,
      uv_warnings: true
    }
  },
  statistics: {
    total_tracks: 156,
    total_distance: 125600, // ç±³
    total_time: 89400, // ç§’
    avg_comfort_score: 7.2,
    favorite_routes: [ObjectId, ...],
    achievement_badges: ["early_bird", "shadow_seeker"]
  },
  last_active: ISODate
}
```

#### 5. ğŸŒ¤ï¸ **å¤©æ°”æ•°æ®ç¼“å­˜** (æ€§èƒ½ä¼˜åŒ–)
**å­˜å‚¨åŸå› **ï¼šå‡å°‘å¤–éƒ¨APIè°ƒç”¨ã€å†å²æ•°æ®åˆ†æ
```javascript
// Collection: weather_cache
{
  _id: ObjectId,
  location: {
    type: "Point",
    coordinates: [lng, lat]
  },
  grid_cell: "39_116", // ç®€åŒ–çš„ç½‘æ ¼æ ‡è¯†
  timestamp: ISODate,
  data: {
    temperature: 23.5,
    humidity: 65,
    cloud_cover: 0.3,
    uv_index: 6,
    wind_speed: 2.2,
    wind_direction: 180,
    visibility: 10000,
    precipitation: 0
  },
  source: "nullschool.net",
  expires_at: ISODate,
  created_at: ISODate
}
```

#### 6. ğŸ›£ï¸ **è·¯çº¿æ¨èæ•°æ®** (æ™ºèƒ½æ¨è)
**å­˜å‚¨åŸå› **ï¼šé¢„è®¡ç®—è·¯çº¿ã€æ¨èç®—æ³•ã€ç”¨æˆ·åé¦ˆ
```javascript
// Collection: route_recommendations
{
  _id: ObjectId,
  origin: {
    type: "Point",
    coordinates: [lng, lat],
    address: "åŒ—äº¬å¸‚æœé˜³åŒº..."
  },
  destination: {
    type: "Point", 
    coordinates: [lng, lat],
    address: "åŒ—äº¬å¸‚æµ·æ·€åŒº..."
  },
  route_options: [{
    route_id: "route_001",
    geometry: {
      type: "LineString",
      coordinates: [[lng, lat], ...]
    },
    metrics: {
      total_distance: 2500,
      estimated_time: 30, // åˆ†é’Ÿ
      shadow_coverage: 0.75, // é˜´å½±è¦†ç›–ç‡
      comfort_score: 8.2,
      uv_exposure: 2.1
    },
    optimization_target: "min_sun_exposure", // min_sun_exposure, max_comfort, fastest
    weather_conditions: {
      optimal_times: ["08:00-10:00", "16:00-18:00"],
      avoid_times: ["12:00-14:00"]
    }
  }],
  popularity: {
    usage_count: 45,
    avg_rating: 4.2,
    last_used: ISODate
  },
  created_at: ISODate,
  expires_at: ISODate
}
```

### ğŸ“ **ä¸éœ€è¦MongoDBå­˜å‚¨çš„æ•°æ®**

#### 1. ğŸ–¼ï¸ **DEMç“¦ç‰‡æ–‡ä»¶æœ¬èº«**
- **å­˜å‚¨ä½ç½®**ï¼šæ–‡ä»¶ç³»ç»Ÿ + CDN
- **åŸå› **ï¼šäºŒè¿›åˆ¶æ•°æ®ã€å¤§æ–‡ä»¶ã€é€‚åˆCDNç¼“å­˜
- **è®¿é—®æ–¹å¼**ï¼šç›´æ¥HTTPè¯·æ±‚

#### 2. ğŸ¨ **å‰ç«¯é™æ€èµ„æº**
- **å­˜å‚¨ä½ç½®**ï¼šCDN
- **åŒ…å«**ï¼šJSã€CSSã€å›¾ç‰‡ã€å­—ä½“
- **åŸå› **ï¼šé™æ€å†…å®¹ã€å…¨çƒåˆ†å‘

#### 3. ğŸ“Š **å®æ—¶è®¡ç®—ç»“æœ**
- **å­˜å‚¨ä½ç½®**ï¼šå†…å­˜ç¼“å­˜ï¼ˆRedisï¼‰
- **åŒ…å«**ï¼šä¸´æ—¶é˜´å½±è®¡ç®—ã€å®æ—¶å¤©æ°”
- **åŸå› **ï¼šçŸ­æœŸæœ‰æ•ˆã€é¢‘ç¹æ›´æ–°

## ğŸ” æ•°æ®è®¿é—®æ¨¡å¼è®¾è®¡

### 1. **å»ºç­‘ç‰©æ•°æ®è®¿é—®**
```typescript
// æŒ‰ç“¦ç‰‡æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
GET /api/buildings/tile/{z}/{x}/{y}
// å®ç°ï¼štileç´¢å¼• + åœ°ç†ç©ºé—´æŸ¥è¯¢

// æŒ‰åŒºåŸŸæŸ¥è¯¢
GET /api/buildings/bounds?west=116.3&south=39.9&east=116.4&north=40.0
// å®ç°ï¼š2dsphereç´¢å¼•

// æŒ‰å»ºç­‘ç±»å‹æŸ¥è¯¢
GET /api/buildings/type/residential?bounds=...
// å®ç°ï¼šbuildingTypeç´¢å¼• + åœ°ç†ç©ºé—´æŸ¥è¯¢
```

### 2. **ç”¨æˆ·è½¨è¿¹æ•°æ®è®¿é—®**
```typescript
// ç”¨æˆ·çš„æ‰€æœ‰è½¨è¿¹
GET /api/tracks/user/{user_id}
// å®ç°ï¼šuser_idç´¢å¼•

// å…¬å¼€çš„è½¨è¿¹ï¼ˆç¤¾åŒºåŠŸèƒ½ï¼‰
GET /api/tracks/public?activity=running&comfort_min=7
// å®ç°ï¼šprivacy + activity_type + comfort_scoreç´¢å¼•

// åŒºåŸŸå†…çš„è½¨è¿¹
GET /api/tracks/area?bounds=...
// å®ç°ï¼šrouteåœ°ç†ç©ºé—´ç´¢å¼•
```

### 3. **è·¯çº¿æ¨èè®¿é—®**
```typescript
// è·å–è·¯çº¿æ¨è
POST /api/routes/recommend
{
  "origin": [lng, lat],
  "destination": [lng, lat], 
  "preferences": {
    "optimization": "min_sun_exposure",
    "activity": "walking"
  }
}
// å®ç°ï¼šåœ°ç†ç©ºé—´æŸ¥è¯¢ + ç¼“å­˜ç­–ç•¥
```

## ğŸš€ é«˜æ€§èƒ½è®¿é—®ç­–ç•¥

### 1. **ç´¢å¼•ä¼˜åŒ–**
```javascript
// åœ°ç†ç©ºé—´ç´¢å¼•
db.buildings.createIndex({ "geometry": "2dsphere" })
db.user_tracks.createIndex({ "route": "2dsphere" })
db.weather_cache.createIndex({ "location": "2dsphere" })

// å¤åˆç´¢å¼•
db.buildings.createIndex({ 
  "tile.z": 1, 
  "tile.x": 1, 
  "tile.y": 1,
  "properties.height": -1 
})

// æ—¶é—´åºåˆ—ç´¢å¼•
db.user_tracks.createIndex({ "user_id": 1, "created_at": -1 })
db.weather_cache.createIndex({ "expires_at": 1 }, { expireAfterSeconds: 0 })
```

### 2. **ç¼“å­˜ç­–ç•¥**
```typescript
// å¤šçº§ç¼“å­˜æ¶æ„
const cacheStrategy = {
  // L1: å†…å­˜ç¼“å­˜ï¼ˆæœ€çƒ­æ•°æ®ï¼‰
  memory: {
    buildingTiles: "5 minutes",
    weatherData: "2 minutes"
  },
  
  // L2: MongoDBï¼ˆæŒä¹…åŒ–ç¼“å­˜ï¼‰
  mongodb: {
    buildings: "30 days",
    demMetadata: "æ°¸ä¹…",
    weatherCache: "6 hours"
  },
  
  // L3: å¤–éƒ¨APIï¼ˆæœ€åé€‰æ‹©ï¼‰
  external: {
    osmApi: "å®æ—¶è·å–",
    weatherApi: "å®æ—¶è·å–"
  }
};
```

### 3. **åˆ†é¡µå’Œé™åˆ¶**
```typescript
// å¤§æ•°æ®é›†åˆ†é¡µ
const paginationConfig = {
  defaultLimit: 50,
  maxLimit: 1000,
  cursorBased: true, // ä½¿ç”¨cursoråˆ†é¡µè€Œéoffset
  
  // ç¤ºä¾‹API
  // GET /api/tracks?cursor=ObjectId&limit=50
};
```

## ğŸ“ˆ æ•°æ®å¢é•¿é¢„ä¼°

### å®¹é‡è§„åˆ’
```javascript
const dataGrowthEstimate = {
  buildings: {
    recordSize: "2KB per building",
    globalEstimate: "100M buildings = 200GB",
    hotCities: "10M buildings = 20GB",
    growth: "10% per year"
  },
  
  userTracks: {
    recordSize: "5KB per track", 
    dailyTracks: "1000 tracks/day = 5MB/day",
    yearlyGrowth: "1.8GB per year",
    retention: "Keep all data (historical analysis)"
  },
  
  weatherCache: {
    recordSize: "1KB per record",
    coverage: "Global grid 1km = 510M records = 510GB",
    actualUsage: "Hot areas only = 10GB",
    ttl: "6 hours (auto cleanup)"
  }
};
```

è¿™ä¸ªæ•°æ®æ¶æ„è®¾è®¡ä¸ºShadowMapé¡¹ç›®æä¾›äº†ï¼š
- ğŸƒâ€â™‚ï¸ **é«˜æ€§èƒ½**ï¼šä¼˜åŒ–çš„ç´¢å¼•å’ŒæŸ¥è¯¢æ¨¡å¼
- ğŸŒ **å¯æ‰©å±•**ï¼šæ”¯æŒå…¨çƒæ•°æ®å’Œå¤§é‡ç”¨æˆ·
- ğŸ§  **æ™ºèƒ½åŒ–**ï¼šæ”¯æŒå¤æ‚çš„å‡ºè¡Œåˆ†æå’Œæ¨è
- ğŸ’¾ **ç»æµæ€§**ï¼šåˆç†çš„å­˜å‚¨ç­–ç•¥å’Œæ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
