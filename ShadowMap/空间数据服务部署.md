# 空间数据服务部署指南

## 概述

本指南将帮助你在Ubuntu工作站上部署PostgreSQL + PostGIS + GeoServer的完整空间数据服务栈，实现类似TUM WFS的专业地理数据服务。

## 架构图

```
前端应用 (Windows)
    ↓ HTTP/WFS请求
学校局域网 (WiFi)
    ↓
Ubuntu工作站
    ├── GeoServer (端口8080) → 提供WFS/WMS服务
    ├── PostgreSQL (端口5432) → 数据库服务
    └── PostGIS → 空间数据扩展
```

## 第一阶段：环境准备

### 1.1 检查网络连接

**在工作站上执行：**
```bash
# 查看工作站IP地址
hostname -I
ip addr show

# 开启防火墙端口（如果需要）
sudo ufw allow 8080  # GeoServer
sudo ufw allow 5432  # PostgreSQL
```

**在Windows电脑上测试：**
```bash
# 替换为实际的工作站IP
ping 10.13.12.164
telnet 10.13.12.164 8080
```

### 1.2 系统更新
```bash
sudo apt update
sudo apt upgrade -y
```

## 第二阶段：安装数据库服务

### 2.1 安装PostgreSQL
```bash
# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 检查状态
sudo systemctl status postgresql
```

### 2.2 安装PostGIS扩展
```bash
# 安装PostGIS
sudo apt install -y postgis postgresql-14-postgis-3

# 或者根据你的PostgreSQL版本调整
sudo apt install -y postgis postgresql-postgis
```

### 2.3 配置数据库

**创建GIS数据库：**
```bash
# 切换到postgres用户
sudo -u postgres psql

# 在PostgreSQL命令行中执行：
CREATE DATABASE shadowmap_gis;
CREATE USER gisuser WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE shadowmap_gis TO gisuser;
\q
```

**启用PostGIS扩展：**
```bash
# 连接到新数据库（必须用postgres超级用户）
sudo -u postgres psql -d shadowmap_gis

# 启用PostGIS扩展
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;

# 给gisuser授权访问PostGIS相关表
GRANT ALL ON ALL TABLES IN SCHEMA public TO gisuser;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO gisuser;

# 检查安装
SELECT PostGIS_Version();
\q
```

**常见问题：** 如果后续遇到"function postgis_version() does not exist"错误，说明扩展没有正确安装到数据库，重新执行上述命令。

### 2.4 配置远程访问

**编辑postgresql.conf：**
```bash
sudo nano /etc/postgresql/14/main/postgresql.conf

# 找到并修改：
listen_addresses = '*'  # 允许所有IP连接
port = 5432
```

**编辑pg_hba.conf：**
```bash
sudo nano /etc/postgresql/14/main/pg_hba.conf

# 在文件末尾添加：
host    all             all             192.168.0.0/16          md5
```

**重启PostgreSQL：**
```bash
sudo systemctl restart postgresql
```

## 第三阶段：安装GeoServer

### 3.1 安装Java环境
```bash
# 安装OpenJDK 11
sudo apt install -y openjdk-11-jdk

# 验证安装
java -version
```

### 3.2 下载和安装GeoServer
```bash
# 创建geoserver用户（使用bash shell以便运行Java进程）
sudo useradd -r -m -s /bin/bash geoserver

# 下载GeoServer
cd /tmp
wget https://sourceforge.net/projects/geoserver/files/GeoServer/2.24.0/geoserver-2.24.0-bin.zip

# 解压到/opt（会直接解压到/opt/目录下）
sudo unzip geoserver-2.24.0-bin.zip -d /opt/

# 创建geoserver目录并移动所有文件
sudo mkdir -p /opt/geoserver
sudo mv /opt/bin /opt/data_dir /opt/etc /opt/lib /opt/license /opt/LICENSE.html \
        /opt/licenses /opt/logs /opt/modules /opt/README.html /opt/resources \
        /opt/RUNNING.html /opt/start.ini /opt/start.jar /opt/VERSION.txt \
        /opt/webapps /opt/geoserver/

# 设置所有权
sudo chown -R geoserver:geoserver /opt/geoserver

# 验证安装
ls -la /opt/geoserver/
```

### 3.3 配置GeoServer服务

**创建systemd服务文件：**
```bash
sudo nano /etc/systemd/system/geoserver.service
```

**服务文件内容：**
```ini
[Unit]
Description=GeoServer
After=network.target

[Service]
Type=simple
User=geoserver
Group=geoserver
Environment=JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
Environment=GEOSERVER_HOME=/opt/geoserver
Environment=GEOSERVER_DATA_DIR=/opt/geoserver/data_dir
WorkingDirectory=/opt/geoserver
ExecStart=/usr/bin/java -DGEOSERVER_DATA_DIR=/opt/geoserver/data_dir -jar /opt/geoserver/start.jar
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启动GeoServer：**
```bash
sudo systemctl daemon-reload
sudo systemctl start geoserver
sudo systemctl enable geoserver

# 检查状态
sudo systemctl status geoserver
```

### 3.4 验证GeoServer安装

**在工作站本机浏览器访问：**
```
http://localhost:8080/geoserver
```

**在同一局域网的其他电脑访问：**
```bash
# 先在工作站查看IP地址
hostname -I

# 然后在其他电脑浏览器访问
http://工作站IP:8080/geoserver
# 例如: http://192.168.1.100:8080/geoserver
```

**开放防火墙端口（如果无法访问）：**
```bash
sudo ufw allow 8080
sudo ufw status
```

**默认登录信息：**
- 用户名: admin
- 密码: geoserver

## 第四阶段：数据导入

### 4.1 数据传输方式

**方式1：SCP传输（适合单次上传）**
```bash
# 在Windows PowerShell或Git Bash执行
scp "E:\path\to\e010_n50_e015_n45.geojson" username@10.13.12.164:/tmp/
```

**方式2：SMB共享文件夹（推荐，适合频繁传输）**

在工作站上配置Samba共享：
```bash
# 1. 创建共享目录
sudo mkdir -p /srv/gis_data
sudo chown username:username /srv/gis_data

# 2. 安装Samba
sudo apt install -y samba

# 3. 配置共享
sudo nano /etc/samba/smb.conf
# 在文件末尾添加：
# [gis_data]
# path = /srv/gis_data
# browseable = yes
# writable = yes
# guest ok = no
# valid users = username

# 4. 设置Samba密码
sudo smbpasswd -a username

# 5. 重启服务
sudo systemctl restart smbd
sudo ufw allow samba
```

在Windows上访问共享文件夹：
```
1. 按 Win + R
2. 输入：\\10.13.12.164\gis_data
3. 回车，输入用户名和Samba密码
4. 直接拖拽文件到共享文件夹
```

**注意：** 不要用浏览器打开`\\10.13.12.164`，必须用Windows文件资源管理器。

### 4.2 安装数据导入工具
```bash
# 安装GDAL工具
sudo apt install -y gdal-bin

# 安装Python工具（可选）
pip install geopandas psycopg2-binary
```

### 4.3 导入GeoJSON数据

**方法1：使用ogr2ogr（推荐）**
```bash
# 确保数据文件已通过SCP传输到工作站
# scp "E:\path\to\e010_n50_e015_n45.geojson" username@工作站IP:/tmp/

# 导入GeoJSON文件到PostGIS（替换your_password为实际密码）
ogr2ogr -f "PostgreSQL" \
    PG:"host=localhost user=gisuser password=your_password dbname=shadowmap_gis" \
    /tmp/e010_n50_e015_n45.geojson \
    -nln buildings \
    -overwrite \
    -progress

# 注意：
# - 文件路径必须是工作站上的实际路径，不能是占位符
# - 密码必须与CREATE USER时设置的密码一致
# - 导入8GB数据约需5-15分钟，会显示进度条
```

**常见错误排查：**
```bash
# 错误1：Unable to open datasource - 检查文件路径
ls -lh /tmp/e010_n50_e015_n45.geojson

# 错误2：password authentication failed - 重置密码
sudo -u postgres psql
ALTER USER gisuser WITH PASSWORD 'new_password';
\q
```

**方法2：使用Python脚本**
```python
import geopandas as gpd
from sqlalchemy import create_engine

# 读取GeoJSON（分块处理大文件）
engine = create_engine('postgresql://gisuser:your_secure_password@localhost/shadowmap_gis')

# 分块读取和导入
chunk_size = 10000
for chunk in gpd.read_file('your_file.geojson', chunksize=chunk_size):
    chunk.to_postgis('buildings', engine, if_exists='append', index=False)
```

### 4.4 转换几何数据并创建空间索引

**问题说明：** ogr2ogr导入的几何列是`wkb_geometry`（bytea类型），需要转换为PostGIS的`geometry`类型。

```bash
# 登录数据库
psql -h localhost -U gisuser -d shadowmap_gis

# 如果遇到密码认证问题，用postgres超级用户重置密码：
# sudo -u postgres psql
# ALTER USER gisuser WITH PASSWORD 'your_password';
# \q

# 在shadowmap_gis数据库中执行以下SQL：

-- 1. 添加PostGIS几何列
ALTER TABLE buildings ADD COLUMN geom geometry(Geometry, 4326);

-- 2. 从wkb_geometry转换数据（这步会花几分钟）
UPDATE buildings SET geom = ST_GeomFromWKB(wkb_geometry, 4326);

-- 3. 创建空间索引（加速空间查询）
CREATE INDEX buildings_geom_idx ON buildings USING GIST (geom);

-- 4. 创建属性索引（加速height查询）
CREATE INDEX buildings_height_idx ON buildings (height);

-- 5. 分析表统计信息（优化查询计划）
ANALYZE buildings;

-- 6. 查看导入结果
SELECT COUNT(*) as total_buildings FROM buildings;
SELECT MIN(height), MAX(height), AVG(height) FROM buildings WHERE height IS NOT NULL;

-- 7. 测试空间查询（慕尼黑市中心）
SELECT COUNT(*) FROM buildings 
WHERE ST_Intersects(geom, ST_MakeEnvelope(11.5, 48.1, 11.6, 48.2, 4326));

-- 8. 退出
\q
```

**预期结果：**
- 数据行数：约1400-1500万条（取决于5°×5°瓦片范围）
- UPDATE命令执行时间：3-10分钟
- 索引创建时间：1-3分钟

## 第五阶段：GeoServer配置

### 5.1 创建数据存储

1. 登录GeoServer Web界面
2. 点击 "Data" → "Stores" → "Add new Store"
3. 选择 "PostGIS - PostGIS Database"
4. 配置连接参数：
   - Data Source Name: `shadowmap_postgis`
   - Host: `localhost`
   - Port: `5432`
   - Database: `shadowmap_gis`
   - User: `gisuser`
   - Password: `your_secure_password`

### 5.2 发布图层

1. 点击 "Data" → "Layers" → "Add a new layer"
2. 选择刚创建的数据存储
3. 选择 `buildings` 表
4. 点击 "Publish"
5. 配置图层属性：
   - Name: `buildings`
   - Title: `Building Footprints`
   - SRS: `EPSG:4326`
   - Bounding Box: 点击 "Compute from data"

### 5.3 配置WFS服务

1. 点击 "Services" → "WFS"
2. 启用以下选项：
   - Enable WFS: ✓
   - Maximum number of features: 50000
   - Service Level: COMPLETE

## 第六阶段：测试和验证

### 6.1 测试WFS服务

**GetCapabilities请求：**
```
http://10.13.12.164:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetCapabilities
```

**GetFeature请求：**
```
http://10.13.12.164:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=buildings&maxFeatures=10
```

**边界框查询：**
```
http://10.13.12.164:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=buildings&bbox=11.5,48.1,11.6,48.2,EPSG:4326
```

### 6.2 性能测试

**PostgreSQL查询测试：**
```sql
-- 测试空间查询性能
EXPLAIN ANALYZE 
SELECT * FROM buildings 
WHERE ST_Intersects(geom, ST_MakeEnvelope(11.5, 48.1, 11.6, 48.2, 4326));
```

### 6.3 前端集成

**修改前端API端点：**
```typescript
// 在你的前端代码中
const WFS_BASE_URL = 'http://工作站IP:8080/geoserver/wfs';

// 替换原来的TUM WFS调用
const response = await fetch(`${WFS_BASE_URL}?service=WFS&version=1.0.0&request=GetFeature&typeName=buildings&bbox=${bbox}&outputFormat=application/json`);
```

## 第七阶段：优化和监控

### 7.1 PostgreSQL优化

**编辑postgresql.conf：**
```bash
# 内存配置（根据工作站内存调整）
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 256MB
maintenance_work_mem = 1GB

# 连接配置
max_connections = 100
```

### 7.2 GeoServer优化

**JVM参数调整：**
```bash
# 编辑启动脚本
sudo nano /opt/geoserver/bin/startup.sh

# 添加JVM参数
export JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -Dfile.encoding=UTF8"
```

### 7.3 监控脚本

**创建健康检查脚本：**
```bash
#!/bin/bash
# health_check.sh

# 检查PostgreSQL
pg_isready -h localhost -p 5432 -U gisuser

# 检查GeoServer
curl -f http://localhost:8080/geoserver/web/ > /dev/null

echo "Services status checked at $(date)"
```

## 故障排除

### 常见问题

1. **连接被拒绝**
   - 检查防火墙设置
   - 验证服务是否运行
   - 检查端口配置

2. **权限错误**
   - 检查数据库用户权限
   - 验证文件所有权

3. **性能问题**
   - 检查空间索引
   - 调整内存配置
   - 监控查询性能

### 日志位置

- PostgreSQL: `/var/log/postgresql/`
- GeoServer: `/opt/geoserver/logs/`
- 系统服务: `journalctl -u geoserver`

## 安全建议

1. 修改默认密码
2. 配置SSL/TLS加密
3. 限制网络访问范围
4. 定期备份数据
5. 监控系统资源使用

## 备份策略

```bash
# 数据库备份
pg_dump -h localhost -U gisuser shadowmap_gis > backup_$(date +%Y%m%d).sql

# GeoServer配置备份
tar -czf geoserver_config_$(date +%Y%m%d).tar.gz /opt/geoserver/data_dir
```

---

## 总结

完成以上步骤后，你将拥有一个专业级的空间数据服务，可以：

✅ 高效处理TB级空间数据  
✅ 提供标准WFS/WMS服务  
✅ 支持复杂空间查询  
✅ 具备良好的扩展性  
✅ 兼容所有GIS客户端  

这个架构可以轻松扩展到全球数据规模，为你的ShadowMap项目提供坚实的数据基础。
